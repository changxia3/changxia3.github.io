<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x1 前言在前面两篇笔记中都提到过Shiro反序列化漏洞的坑：在Shiro反序列化漏洞检测中，如果直接使用CommonCollections3、5、6、7链会导致反序列化漏洞无法利用成功，这篇笔记就来记录一下失败原因的分析过程。 0x2 分析过程这里使用的还是之前shiro的samples环境，加入commons-collections-3.2.1依赖。首先使用ysoserial的Commons">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro反序列化漏洞笔记三（解疑篇）">
<meta property="og:url" content="http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/index.html">
<meta property="og:site_name" content="长夏">
<meta property="og:description" content="0x1 前言在前面两篇笔记中都提到过Shiro反序列化漏洞的坑：在Shiro反序列化漏洞检测中，如果直接使用CommonCollections3、5、6、7链会导致反序列化漏洞无法利用成功，这篇笔记就来记录一下失败原因的分析过程。 0x2 分析过程这里使用的还是之前shiro的samples环境，加入commons-collections-3.2.1依赖。首先使用ysoserial的Commons">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/1.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/2.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/3.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/4.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/5.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/6.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/7.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/8.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/9.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/10.png">
<meta property="og:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/11.png">
<meta property="article:published_time" content="2020-10-03T09:57:01.000Z">
<meta property="article:modified_time" content="2022-04-17T14:47:04.086Z">
<meta property="article:author" content="长夏">
<meta property="article:tag" content="JAVA反序列化漏洞">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/1.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Shiro反序列化漏洞笔记三（解疑篇）</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="长夏" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/12/27/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E5%9B%9B%EF%BC%88%E5%AE%9E%E6%88%98%E7%AF%87%EF%BC%89/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/09/05/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%BA%8C%EF%BC%88%E6%A3%80%E6%B5%8B%E7%AF%87%EF%BC%89/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&text=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&is_video=false&description=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Shiro反序列化漏洞笔记三（解疑篇）&body=Check out this article: http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&name=Shiro反序列化漏洞笔记三（解疑篇）&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&t=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-前言"><span class="toc-number">1.</span> <span class="toc-text">0x1 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-分析过程"><span class="toc-number">2.</span> <span class="toc-text">0x2 分析过程</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Shiro反序列化漏洞笔记三（解疑篇）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">长夏</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-10-03T09:57:01.000Z" itemprop="datePublished">2020-10-03</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" rel="tag">JAVA反序列化漏洞</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0x1-前言"><a href="#0x1-前言" class="headerlink" title="0x1 前言"></a>0x1 前言</h2><p>在前面两篇笔记中都提到过Shiro反序列化漏洞的坑：在Shiro反序列化漏洞检测中，如果直接使用CommonCollections3、5、6、7链会导致反序列化漏洞无法利用成功，这篇笔记就来记录一下失败原因的分析过程。</p>
<h2 id="0x2-分析过程"><a href="#0x2-分析过程" class="headerlink" title="0x2 分析过程"></a>0x2 分析过程</h2><p>这里使用的还是之前shiro的samples环境，加入commons-collections-3.2.1依赖。首先使用ysoserial的CommonsCollections6生成EXP，从Catalina日志可以看到反序列化失败，提示找不到[Lorg.apache.commons.collections.Transformer这个类。</p>
<p><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/1.png" alt=""></p>
<p>在报错代码附近，即反序列化代码处下断点。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/2.png" alt=""></p>
<p>进一步跟进可以发现ClassResolvingObjectInputStream继承了ObjectInputStream，并且重写了resolveClass方法。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/3.png" alt=""></p>
<p>原本ObjectInputStream类中resolve方法如下。对比可以发现Shiro使用了重新定义的ClassUtils.forName方法代替了原本ObjectInputStream类中的Class.forName。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">    throws IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    String name &#x3D; desc.getName();</span><br><span class="line">    try &#123;</span><br><span class="line">        return Class.forName(name, false, latestUserDefinedLoader());</span><br><span class="line">    &#125; catch (ClassNotFoundException ex) &#123;</span><br><span class="line">        Class&lt;?&gt; cl &#x3D; primClasses.get(name);</span><br><span class="line">        if (cl !&#x3D; null) &#123;</span><br><span class="line">            return cl;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进ClassUtils类的forName方法，发现最终使用loadClass来加载类，默认使用THREAD_CL_ACCESSOR.loadClass来进行加载，如果不成功会依次再使用CLASS_CL_ACCESSOR.loadClass和SYSTEM_CL_ACCESSOR.loadClass来进行加载。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/4.png" alt=""></p>
<p>三个ClassLoaderAccessor定义如下，THREAD_CL_ACCESSOR返回当前线程上下文的ClassLoader，在Tomcat中间件中，返回的当前线程上下文的ClassLoader为ParallelWebappClassLoader。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;THREAD_CL_ACCESSOR</span><br><span class="line">private static final ClassLoaderAccessor THREAD_CL_ACCESSOR &#x3D; new ExceptionIgnoringAccessor() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected ClassLoader doGetClassLoader() throws Throwable &#123;</span><br><span class="line">            return Thread.currentThread().getContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;CLASS_CL_ACCESSOR</span><br><span class="line">private static final ClassLoaderAccessor CLASS_CL_ACCESSOR &#x3D; new ExceptionIgnoringAccessor() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected ClassLoader doGetClassLoader() throws Throwable &#123;</span><br><span class="line">            return ClassUtils.class.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;SYSTEM_CL_ACCESSOR</span><br><span class="line">private static final ClassLoaderAccessor SYSTEM_CL_ACCESSOR &#x3D; new ExceptionIgnoringAccessor() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected ClassLoader doGetClassLoader() throws Throwable &#123;</span><br><span class="line">            return ClassLoader.getSystemClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/5.png" alt=""></p>
<p>跟到clazz = cl.loadClass(fqcn);再下一步进入到Tomcat的WebappClassLoaderBase类了。</p>
<p><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/6.png" alt=""></p>
<p>如果需要进一步跟进Tomcat的运行情况，需要先加入Tomcat的依赖。这里是mvn项目，在pom.xml添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.tomcat.embed&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;tomcat-embed-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;9.0.19&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>进入到WebappClassLoaderBase类，WebappClassLoaderBase继承自URLClassLoader。loadClass就是Tomcat的类加载器的核心实现代码了。</p>
<p><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/7.png" alt=""></p>
<p>loadClass方法具体代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">public Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        synchronized (getClassLoadingLock(name)) &#123;</span><br><span class="line">            if (log.isDebugEnabled())</span><br><span class="line">                log.debug(&quot;loadClass(&quot; + name + &quot;, &quot; + resolve + &quot;)&quot;);</span><br><span class="line">            Class&lt;?&gt; clazz &#x3D; null;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Log access to stopped class loader</span><br><span class="line">            checkStateForClassLoading(name);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; (0) Check our previously loaded local class cache</span><br><span class="line">            clazz &#x3D; findLoadedClass0(name);</span><br><span class="line">            if (clazz !&#x3D; null) &#123;</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;  Returning class from cache&quot;);</span><br><span class="line">                if (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                return clazz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; (0.1) Check our previously loaded class cache</span><br><span class="line">            clazz &#x3D; findLoadedClass(name);</span><br><span class="line">            if (clazz !&#x3D; null) &#123;</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;  Returning class from cache&quot;);</span><br><span class="line">                if (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                return clazz;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; (0.2) Try loading the class with the system class loader, to prevent</span><br><span class="line">            &#x2F;&#x2F;       the webapp from overriding Java SE classes. This implements</span><br><span class="line">            &#x2F;&#x2F;       SRV.10.7.2</span><br><span class="line">            String resourceName &#x3D; binaryNameToPath(name, false);</span><br><span class="line"></span><br><span class="line">            ClassLoader javaseLoader &#x3D; getJavaseClassLoader();</span><br><span class="line">            boolean tryLoadingFromJavaseLoader;</span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; Use getResource as it won&#39;t trigger an expensive</span><br><span class="line">                &#x2F;&#x2F; ClassNotFoundException if the resource is not available from</span><br><span class="line">                &#x2F;&#x2F; the Java SE class loader. However (see</span><br><span class="line">                &#x2F;&#x2F; https:&#x2F;&#x2F;bz.apache.org&#x2F;bugzilla&#x2F;show_bug.cgi?id&#x3D;58125 for</span><br><span class="line">                &#x2F;&#x2F; details) when running under a security manager in rare cases</span><br><span class="line">                &#x2F;&#x2F; this call may trigger a ClassCircularityError.</span><br><span class="line">                &#x2F;&#x2F; See https:&#x2F;&#x2F;bz.apache.org&#x2F;bugzilla&#x2F;show_bug.cgi?id&#x3D;61424 for</span><br><span class="line">                &#x2F;&#x2F; details of how this may trigger a StackOverflowError</span><br><span class="line">                &#x2F;&#x2F; Given these reported errors, catch Throwable to ensure any</span><br><span class="line">                &#x2F;&#x2F; other edge cases are also caught</span><br><span class="line">                URL url;</span><br><span class="line">                if (securityManager !&#x3D; null) &#123;</span><br><span class="line">                    PrivilegedAction&lt;URL&gt; dp &#x3D; new PrivilegedJavaseGetResource(resourceName);</span><br><span class="line">                    url &#x3D; AccessController.doPrivileged(dp);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    url &#x3D; javaseLoader.getResource(resourceName);</span><br><span class="line">                &#125;</span><br><span class="line">                tryLoadingFromJavaseLoader &#x3D; (url !&#x3D; null);</span><br><span class="line">            &#125; catch (Throwable t) &#123;</span><br><span class="line">                &#x2F;&#x2F; Swallow all exceptions apart from those that must be re-thrown</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                &#x2F;&#x2F; The getResource() trick won&#39;t work for this class. We have to</span><br><span class="line">                &#x2F;&#x2F; try loading it directly and accept that we might get a</span><br><span class="line">                &#x2F;&#x2F; ClassNotFoundException.</span><br><span class="line">                tryLoadingFromJavaseLoader &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (tryLoadingFromJavaseLoader) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    clazz &#x3D; javaseLoader.loadClass(name);</span><br><span class="line">                    if (clazz !&#x3D; null) &#123;</span><br><span class="line">                        if (resolve)</span><br><span class="line">                            resolveClass(clazz);</span><br><span class="line">                        return clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Ignore</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; (0.5) Permission to access this class when using a SecurityManager</span><br><span class="line">            if (securityManager !&#x3D; null) &#123;</span><br><span class="line">                int i &#x3D; name.lastIndexOf(&#39;.&#39;);</span><br><span class="line">                if (i &gt;&#x3D; 0) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        securityManager.checkPackageAccess(name.substring(0,i));</span><br><span class="line">                    &#125; catch (SecurityException se) &#123;</span><br><span class="line">                        String error &#x3D; sm.getString(&quot;webappClassLoader.restrictedPackage&quot;, name);</span><br><span class="line">                        log.info(error, se);</span><br><span class="line">                        throw new ClassNotFoundException(error, se);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            boolean delegateLoad &#x3D; delegate || filter(name, true);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; (1) Delegate to our parent if requested</span><br><span class="line">            if (delegateLoad) &#123;</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;  Delegating to parent classloader1 &quot; + parent);</span><br><span class="line">                try &#123;</span><br><span class="line">                    clazz &#x3D; Class.forName(name, false, parent);</span><br><span class="line">                    if (clazz !&#x3D; null) &#123;</span><br><span class="line">                        if (log.isDebugEnabled())</span><br><span class="line">                            log.debug(&quot;  Loading class from parent&quot;);</span><br><span class="line">                        if (resolve)</span><br><span class="line">                            resolveClass(clazz);</span><br><span class="line">                        return clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Ignore</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; (2) Search local repositories</span><br><span class="line">            if (log.isDebugEnabled())</span><br><span class="line">                log.debug(&quot;  Searching local repositories&quot;);</span><br><span class="line">            try &#123;</span><br><span class="line">                clazz &#x3D; findClass(name);</span><br><span class="line">                if (clazz !&#x3D; null) &#123;</span><br><span class="line">                    if (log.isDebugEnabled())</span><br><span class="line">                        log.debug(&quot;  Loading class from local repository&quot;);</span><br><span class="line">                    if (resolve)</span><br><span class="line">                        resolveClass(clazz);</span><br><span class="line">                    return clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                &#x2F;&#x2F; Ignore</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; (3) Delegate to parent unconditionally</span><br><span class="line">            if (!delegateLoad) &#123;</span><br><span class="line">                if (log.isDebugEnabled())</span><br><span class="line">                    log.debug(&quot;  Delegating to parent classloader at end: &quot; + parent);</span><br><span class="line">                try &#123;</span><br><span class="line">                    clazz &#x3D; Class.forName(name, false, parent);</span><br><span class="line">                    if (clazz !&#x3D; null) &#123;</span><br><span class="line">                        if (log.isDebugEnabled())</span><br><span class="line">                            log.debug(&quot;  Loading class from parent&quot;);</span><br><span class="line">                        if (resolve)</span><br><span class="line">                            resolveClass(clazz);</span><br><span class="line">                        return clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Ignore</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        throw new ClassNotFoundException(name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>大体的流程如下：<br>1.findLoadedClass0：检查当前要加载的类是否已经被WebappClassLoader加载过。<br>2.findLoadedClass：从java.lang.ClassLoader类加载缓存检查当前类是否已经被加载过。<br>3.javaseLoader.loadClass：尝试使用ExtClassLoader类加载器加载类。<br>4.如果前三步没找到，通过filter()检查类是否在定义的名单范围内，如果在的话则遵循双亲委派机制，使用Class.forName()加载类。由于delegate默认为false，并且符合filter()检查的类比较少，所以可以认为Tomcat在实现大多数类的加载的时候并不遵循双亲委派机制，也就是一般会跳过这一步。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">protected boolean filter(String name, boolean isClassName) &#123;</span><br><span class="line"></span><br><span class="line">    if (name &#x3D;&#x3D; null)</span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    char ch;</span><br><span class="line">    if (name.startsWith(&quot;javax&quot;)) &#123;</span><br><span class="line">        &#x2F;* 5 &#x3D;&#x3D; length(&quot;javax&quot;) *&#x2F;</span><br><span class="line">        if (name.length() &#x3D;&#x3D; 5) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        ch &#x3D; name.charAt(5);</span><br><span class="line">        if (isClassName &amp;&amp; ch &#x3D;&#x3D; &#39;.&#39;) &#123;</span><br><span class="line">            &#x2F;* 6 &#x3D;&#x3D; length(&quot;javax.&quot;) *&#x2F;</span><br><span class="line">            if (name.startsWith(&quot;servlet.jsp.jstl.&quot;, 6)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            if (name.startsWith(&quot;el.&quot;, 6) ||</span><br><span class="line">                name.startsWith(&quot;servlet.&quot;, 6) ||</span><br><span class="line">                name.startsWith(&quot;websocket.&quot;, 6) ||</span><br><span class="line">                name.startsWith(&quot;security.auth.message.&quot;, 6)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (!isClassName &amp;&amp; ch &#x3D;&#x3D; &#39;&#x2F;&#39;) &#123;</span><br><span class="line">            &#x2F;* 6 &#x3D;&#x3D; length(&quot;javax&#x2F;&quot;) *&#x2F;</span><br><span class="line">            if (name.startsWith(&quot;servlet&#x2F;jsp&#x2F;jstl&#x2F;&quot;, 6)) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            if (name.startsWith(&quot;el&#x2F;&quot;, 6) ||</span><br><span class="line">                name.startsWith(&quot;servlet&#x2F;&quot;, 6) ||</span><br><span class="line">                name.startsWith(&quot;websocket&#x2F;&quot;, 6) ||</span><br><span class="line">                name.startsWith(&quot;security&#x2F;auth&#x2F;message&#x2F;&quot;, 6)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (name.startsWith(&quot;org&quot;)) &#123;</span><br><span class="line">        &#x2F;* 3 &#x3D;&#x3D; length(&quot;org&quot;) *&#x2F;</span><br><span class="line">        if (name.length() &#x3D;&#x3D; 3) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        ch &#x3D; name.charAt(3);</span><br><span class="line">        if (isClassName &amp;&amp; ch &#x3D;&#x3D; &#39;.&#39;) &#123;</span><br><span class="line">            &#x2F;* 4 &#x3D;&#x3D; length(&quot;org.&quot;) *&#x2F;</span><br><span class="line">            if (name.startsWith(&quot;apache.&quot;, 4)) &#123;</span><br><span class="line">                &#x2F;* 11 &#x3D;&#x3D; length(&quot;org.apache.&quot;) *&#x2F;</span><br><span class="line">                if (name.startsWith(&quot;tomcat.jdbc.&quot;, 11)) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">                if (name.startsWith(&quot;el.&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;catalina.&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;jasper.&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;juli.&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;tomcat.&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;naming.&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;coyote.&quot;, 11)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (!isClassName &amp;&amp; ch &#x3D;&#x3D; &#39;&#x2F;&#39;) &#123;</span><br><span class="line">            &#x2F;* 4 &#x3D;&#x3D; length(&quot;org&#x2F;&quot;) *&#x2F;</span><br><span class="line">            if (name.startsWith(&quot;apache&#x2F;&quot;, 4)) &#123;</span><br><span class="line">                &#x2F;* 11 &#x3D;&#x3D; length(&quot;org&#x2F;apache&#x2F;&quot;) *&#x2F;</span><br><span class="line">                if (name.startsWith(&quot;tomcat&#x2F;jdbc&#x2F;&quot;, 11)) &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">                if (name.startsWith(&quot;el&#x2F;&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;catalina&#x2F;&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;jasper&#x2F;&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;juli&#x2F;&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;tomcat&#x2F;&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;naming&#x2F;&quot;, 11) ||</span><br><span class="line">                    name.startsWith(&quot;coyote&#x2F;&quot;, 11)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.在本地仓库中寻找该类，调用findClass实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">public Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    if (log.isDebugEnabled())</span><br><span class="line">        log.debug(&quot;    findClass(&quot; + name + &quot;)&quot;);</span><br><span class="line"></span><br><span class="line">    checkStateForClassLoading(name);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; (1) Permission to define this class when using a SecurityManager</span><br><span class="line">    if (securityManager !&#x3D; null) &#123;</span><br><span class="line">        int i &#x3D; name.lastIndexOf(&#39;.&#39;);</span><br><span class="line">        if (i &gt;&#x3D; 0) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                if (log.isTraceEnabled())</span><br><span class="line">                    log.trace(&quot;      securityManager.checkPackageDefinition&quot;);</span><br><span class="line">                securityManager.checkPackageDefinition(name.substring(0,i));</span><br><span class="line">            &#125; catch (Exception se) &#123;</span><br><span class="line">                if (log.isTraceEnabled())</span><br><span class="line">                    log.trace(&quot;      --&gt;Exception--&gt;ClassNotFoundException&quot;, se);</span><br><span class="line">                throw new ClassNotFoundException(name, se);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Ask our superclass to locate this class, if possible</span><br><span class="line">    &#x2F;&#x2F; (throws ClassNotFoundException if it is not found)</span><br><span class="line">    Class&lt;?&gt; clazz &#x3D; null;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (log.isTraceEnabled())</span><br><span class="line">            log.trace(&quot;      findClassInternal(&quot; + name + &quot;)&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            if (securityManager !&#x3D; null) &#123;</span><br><span class="line">                PrivilegedAction&lt;Class&lt;?&gt;&gt; dp &#x3D;</span><br><span class="line">                    new PrivilegedFindClassByName(name);</span><br><span class="line">                clazz &#x3D; AccessController.doPrivileged(dp);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                clazz &#x3D; findClassInternal(name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch(AccessControlException ace) &#123;</span><br><span class="line">            log.warn(sm.getString(&quot;webappClassLoader.securityException&quot;, name,</span><br><span class="line">                    ace.getMessage()), ace);</span><br><span class="line">            throw new ClassNotFoundException(name, ace);</span><br><span class="line">        &#125; catch (RuntimeException e) &#123;</span><br><span class="line">            if (log.isTraceEnabled())</span><br><span class="line">                log.trace(&quot;      --&gt;RuntimeException Rethrown&quot;, e);</span><br><span class="line">            throw e;</span><br><span class="line">        &#125;</span><br><span class="line">        if ((clazz &#x3D;&#x3D; null) &amp;&amp; hasExternalRepositories) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                clazz &#x3D; super.findClass(name);</span><br><span class="line">            &#125; catch(AccessControlException ace) &#123;</span><br><span class="line">                log.warn(sm.getString(&quot;webappClassLoader.securityException&quot;, name,</span><br><span class="line">                        ace.getMessage()), ace);</span><br><span class="line">                throw new ClassNotFoundException(name, ace);</span><br><span class="line">            &#125; catch (RuntimeException e) &#123;</span><br><span class="line">                if (log.isTraceEnabled())</span><br><span class="line">                    log.trace(&quot;      --&gt;RuntimeException Rethrown&quot;, e);</span><br><span class="line">                throw e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (clazz &#x3D;&#x3D; null) &#123;</span><br><span class="line">            if (log.isDebugEnabled())</span><br><span class="line">                log.debug(&quot;    --&gt; Returning ClassNotFoundException&quot;);</span><br><span class="line">            throw new ClassNotFoundException(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">        if (log.isTraceEnabled())</span><br><span class="line">            log.trace(&quot;    --&gt; Passing on ClassNotFoundException&quot;);</span><br><span class="line">        throw e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Return the class we have located</span><br><span class="line">    if (log.isTraceEnabled())</span><br><span class="line">        log.debug(&quot;      Returning class &quot; + clazz);</span><br><span class="line"></span><br><span class="line">    if (log.isTraceEnabled()) &#123;</span><br><span class="line">        ClassLoader cl;</span><br><span class="line">        if (Globals.IS_SECURITY_ENABLED)&#123;</span><br><span class="line">            cl &#x3D; AccessController.doPrivileged(</span><br><span class="line">                new PrivilegedGetClassLoader(clazz));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            cl &#x3D; clazz.getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(&quot;      Loaded by &quot; + cl.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    return clazz;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终，会调用findClassInternal()，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; findClassInternal(String name) &#123;</span><br><span class="line"></span><br><span class="line">    checkStateForResourceLoading(name);</span><br><span class="line"></span><br><span class="line">    if (name &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    String path &#x3D; binaryNameToPath(name, true);</span><br><span class="line"></span><br><span class="line">    ResourceEntry entry &#x3D; resourceEntries.get(path);</span><br><span class="line">    WebResource resource &#x3D; null;</span><br><span class="line"></span><br><span class="line">    if (entry &#x3D;&#x3D; null) &#123;</span><br><span class="line">        resource &#x3D; resources.getClassLoaderResource(path);</span><br><span class="line"></span><br><span class="line">        if (!resource.exists()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        entry &#x3D; new ResourceEntry();</span><br><span class="line">        entry.lastModified &#x3D; resource.getLastModified();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Add the entry in the local resource repository</span><br><span class="line">        synchronized (resourceEntries) &#123;</span><br><span class="line">            &#x2F;&#x2F; Ensures that all the threads which may be in a race to load</span><br><span class="line">            &#x2F;&#x2F; a particular class all end up with the same ResourceEntry</span><br><span class="line">            &#x2F;&#x2F; instance</span><br><span class="line">            ResourceEntry entry2 &#x3D; resourceEntries.get(path);</span><br><span class="line">            if (entry2 &#x3D;&#x3D; null) &#123;</span><br><span class="line">                resourceEntries.put(path, entry);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                entry &#x3D; entry2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz &#x3D; entry.loadedClass;</span><br><span class="line">    if (clazz !&#x3D; null)</span><br><span class="line">        return clazz;</span><br><span class="line"></span><br><span class="line">    synchronized (getClassLoadingLock(name)) &#123;</span><br><span class="line">        clazz &#x3D; entry.loadedClass;</span><br><span class="line">        if (clazz !&#x3D; null)</span><br><span class="line">            return clazz;</span><br><span class="line"></span><br><span class="line">        if (resource &#x3D;&#x3D; null) &#123;</span><br><span class="line">            resource &#x3D; resources.getClassLoaderResource(path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!resource.exists()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        byte[] binaryContent &#x3D; resource.getContent();</span><br><span class="line">        if (binaryContent &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; Something went wrong reading the class bytes (and will have</span><br><span class="line">            &#x2F;&#x2F; been logged at debug level).</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        Manifest manifest &#x3D; resource.getManifest();</span><br><span class="line">        URL codeBase &#x3D; resource.getCodeBase();</span><br><span class="line">        Certificate[] certificates &#x3D; resource.getCertificates();</span><br><span class="line"></span><br><span class="line">        if (transformers.size() &gt; 0) &#123;</span><br><span class="line">            &#x2F;&#x2F; If the resource is a class just being loaded, decorate it</span><br><span class="line">            &#x2F;&#x2F; with any attached transformers</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Ignore leading &#39;&#x2F;&#39; and trailing CLASS_FILE_SUFFIX</span><br><span class="line">            &#x2F;&#x2F; Should be cheaper than replacing &#39;.&#39; by &#39;&#x2F;&#39; in class name.</span><br><span class="line">            String internalName &#x3D; path.substring(1, path.length() - CLASS_FILE_SUFFIX.length());</span><br><span class="line"></span><br><span class="line">            for (ClassFileTransformer transformer : this.transformers) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    byte[] transformed &#x3D; transformer.transform(</span><br><span class="line">                            this, internalName, null, null, binaryContent);</span><br><span class="line">                    if (transformed !&#x3D; null) &#123;</span><br><span class="line">                        binaryContent &#x3D; transformed;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (IllegalClassFormatException e) &#123;</span><br><span class="line">                    log.error(sm.getString(&quot;webappClassLoader.transformError&quot;, name), e);</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Looking up the package</span><br><span class="line">        String packageName &#x3D; null;</span><br><span class="line">        int pos &#x3D; name.lastIndexOf(&#39;.&#39;);</span><br><span class="line">        if (pos !&#x3D; -1)</span><br><span class="line">            packageName &#x3D; name.substring(0, pos);</span><br><span class="line"></span><br><span class="line">        Package pkg &#x3D; null;</span><br><span class="line"></span><br><span class="line">        if (packageName !&#x3D; null) &#123;</span><br><span class="line">            pkg &#x3D; getPackage(packageName);</span><br><span class="line">            &#x2F;&#x2F; Define the package (if null)</span><br><span class="line">            if (pkg &#x3D;&#x3D; null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (manifest &#x3D;&#x3D; null) &#123;</span><br><span class="line">                        definePackage(packageName, null, null, null, null, null, null, null);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        definePackage(packageName, manifest, codeBase);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Ignore: normal error due to dual definition of package</span><br><span class="line">                &#125;</span><br><span class="line">                pkg &#x3D; getPackage(packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (securityManager !&#x3D; null) &#123;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Checking sealing</span><br><span class="line">            if (pkg !&#x3D; null) &#123;</span><br><span class="line">                boolean sealCheck &#x3D; true;</span><br><span class="line">                if (pkg.isSealed()) &#123;</span><br><span class="line">                    sealCheck &#x3D; pkg.isSealed(codeBase);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    sealCheck &#x3D; (manifest &#x3D;&#x3D; null) || !isPackageSealed(packageName, manifest);</span><br><span class="line">                &#125;</span><br><span class="line">                if (!sealCheck)</span><br><span class="line">                    throw new SecurityException</span><br><span class="line">                        (&quot;Sealing violation loading &quot; + name + &quot; : Package &quot;</span><br><span class="line">                         + packageName + &quot; is sealed.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            clazz &#x3D; defineClass(name, binaryContent, 0,</span><br><span class="line">                    binaryContent.length, new CodeSource(codeBase, certificates));</span><br><span class="line">        &#125; catch (UnsupportedClassVersionError ucve) &#123;</span><br><span class="line">            throw new UnsupportedClassVersionError(</span><br><span class="line">                    ucve.getLocalizedMessage() + &quot; &quot; +</span><br><span class="line">                    sm.getString(&quot;webappClassLoader.wrongVersion&quot;,</span><br><span class="line">                            name));</span><br><span class="line">        &#125;</span><br><span class="line">        entry.loadedClass &#x3D; clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中关键代码主要是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resource &#x3D; resources.getClassLoaderResource(path);</span><br><span class="line">...</span><br><span class="line">clazz &#x3D; defineClass(name, binaryContent, 0, binaryContent.length, new CodeSource(codeBase, certificates));</span><br></pre></td></tr></table></figure>
<p>其中，getClassLoaderResource主要在WEB-INF/classes和WEB-INF/lib/中搜索根据寻找类名，如果寻找到则将class文件字节码内容转成字节流，然后调用ClassLoader的defineClass将字节流转成class对象，从而完成类的加载。<br><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/8.png" alt=""></p>
<p>6.最终，如果以上步骤都无法找到该类，尝试通过Class.forName()进行加载，如果找不到则抛出ClassNotFound异常。</p>
<p>至于为什么[Lorg.apache.commons.collections.Transformer这个数组类会加载失败，主要调试一下上面的5，6步。</p>
<p>数组类的全限定类名在第5步转成路径时会因为加入了<code>[</code>，所以是搜索不到的。</p>
<p><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/9.png" alt=""></p>
<p>而来到第6步，使用Class.forName()进行加载，加载器是URLClassLoader，对应的path中不包含WEB-INF/lib/,因此也无法加载到[Lorg.apache.commons.collections.Transformer这个类，最终抛出异常。</p>
<p><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/10.png" alt=""></p>
<p><img src="https://changxia-1257751451.cos.ap-chengdu.myqcloud.com/Shiro-550-3/11.png" alt=""></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-前言"><span class="toc-number">1.</span> <span class="toc-text">0x1 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-分析过程"><span class="toc-number">2.</span> <span class="toc-text">0x2 分析过程</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&text=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&is_video=false&description=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Shiro反序列化漏洞笔记三（解疑篇）&body=Check out this article: http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&title=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&name=Shiro反序列化漏洞笔记三（解疑篇）&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://changxia3.com/2020/10/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%89%EF%BC%88%E8%A7%A3%E7%96%91%E7%AF%87%EF%BC%89/&t=Shiro反序列化漏洞笔记三（解疑篇）" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2024
    长夏
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
